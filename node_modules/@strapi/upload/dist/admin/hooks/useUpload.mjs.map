{"version":3,"file":"useUpload.mjs","sources":["../../../admin/src/hooks/useUpload.ts"],"sourcesContent":["import * as React from 'react';\n\nimport { useFetchClient, FetchClient } from '@strapi/admin/strapi-admin';\nimport { useMutation, useQueryClient } from 'react-query';\n\nimport { File, RawFile, CreateFile } from '../../../shared/contracts/files';\nimport { pluginId } from '../pluginId';\n\nconst endpoint = `/${pluginId}`;\n\ninterface Asset extends Omit<File, 'id' | 'hash'> {\n  rawFile?: RawFile;\n  id?: File['id'];\n  hash?: File['hash'];\n}\n\nconst uploadAsset = (\n  asset: Asset,\n  folderId: number | null,\n  signal: AbortSignal,\n  onProgress: (progress: number) => void,\n  post: FetchClient['post']\n) => {\n  const { rawFile, caption, name, alternativeText } = asset;\n  const formData = new FormData();\n\n  formData.append('files', rawFile!);\n\n  formData.append(\n    'fileInfo',\n    JSON.stringify({\n      name,\n      caption,\n      alternativeText,\n      folder: folderId,\n    })\n  );\n\n  /**\n   * onProgress is not possible using native fetch\n   * need to look into an alternative to make it work\n   * perhaps using xhr like Axios does\n   */\n  return post(endpoint, formData, {\n    signal,\n  }).then((res) => res.data);\n};\n\nexport const useUpload = () => {\n  const [progress, setProgress] = React.useState(0);\n  const queryClient = useQueryClient();\n  const abortController = new AbortController();\n  const signal = abortController.signal;\n  const { post } = useFetchClient();\n\n  const mutation = useMutation<\n    CreateFile.Response['data'],\n    CreateFile.Response['error'],\n    { asset: Asset; folderId: number | null }\n  >(\n    ({ asset, folderId }) => {\n      return uploadAsset(asset, folderId, signal, setProgress, post);\n    },\n    {\n      onSuccess() {\n        queryClient.refetchQueries([pluginId, 'assets'], { active: true });\n        queryClient.refetchQueries([pluginId, 'asset-count'], { active: true });\n      },\n    }\n  );\n\n  const upload = (asset: Asset, folderId: number | null) =>\n    mutation.mutateAsync({ asset, folderId });\n\n  const cancel = () => abortController.abort();\n\n  return {\n    upload,\n    isLoading: mutation.isLoading,\n    cancel,\n    error: mutation.error,\n    progress,\n    status: mutation.status,\n  };\n};\n"],"names":["endpoint","pluginId","uploadAsset","asset","folderId","signal","onProgress","post","rawFile","caption","name","alternativeText","formData","FormData","append","JSON","stringify","folder","then","res","data","useUpload","progress","setProgress","React","useState","queryClient","useQueryClient","abortController","AbortController","useFetchClient","mutation","useMutation","onSuccess","refetchQueries","active","upload","mutateAsync","cancel","abort","isLoading","error","status"],"mappings":";;;;;AAQA,MAAMA,QAAW,GAAA,CAAC,CAAC,EAAEC,SAAS,CAAC;AAQ/B,MAAMC,WAAc,GAAA,CAClBC,KACAC,EAAAA,QAAAA,EACAC,QACAC,UACAC,EAAAA,IAAAA,GAAAA;IAEA,MAAM,EAAEC,OAAO,EAAEC,OAAO,EAAEC,IAAI,EAAEC,eAAe,EAAE,GAAGR,KAAAA;AACpD,IAAA,MAAMS,WAAW,IAAIC,QAAAA,EAAAA;IAErBD,QAASE,CAAAA,MAAM,CAAC,OAASN,EAAAA,OAAAA,CAAAA;AAEzBI,IAAAA,QAAAA,CAASE,MAAM,CACb,UACAC,EAAAA,IAAAA,CAAKC,SAAS,CAAC;AACbN,QAAAA,IAAAA;AACAD,QAAAA,OAAAA;AACAE,QAAAA,eAAAA;QACAM,MAAQb,EAAAA;AACV,KAAA,CAAA,CAAA;AAGF;;;;MAKA,OAAOG,IAAKP,CAAAA,QAAAA,EAAUY,QAAU,EAAA;AAC9BP,QAAAA;AACF,KAAA,CAAA,CAAGa,IAAI,CAAC,CAACC,GAAAA,GAAQA,IAAIC,IAAI,CAAA;AAC3B,CAAA;MAEaC,SAAY,GAAA,IAAA;AACvB,IAAA,MAAM,CAACC,QAAUC,EAAAA,WAAAA,CAAY,GAAGC,KAAAA,CAAMC,QAAQ,CAAC,CAAA,CAAA;AAC/C,IAAA,MAAMC,WAAcC,GAAAA,cAAAA,EAAAA;AACpB,IAAA,MAAMC,kBAAkB,IAAIC,eAAAA,EAAAA;IAC5B,MAAMxB,MAAAA,GAASuB,gBAAgBvB,MAAM;IACrC,MAAM,EAAEE,IAAI,EAAE,GAAGuB,cAAAA,EAAAA;AAEjB,IAAA,MAAMC,WAAWC,WAKf,CAAA,CAAC,EAAE7B,KAAK,EAAEC,QAAQ,EAAE,GAAA;AAClB,QAAA,OAAOF,WAAYC,CAAAA,KAAAA,EAAOC,QAAUC,EAAAA,MAAAA,EAAQkB,WAAahB,EAAAA,IAAAA,CAAAA;KAE3D,EAAA;AACE0B,QAAAA,SAAAA,CAAAA,GAAAA;AACEP,YAAAA,WAAAA,CAAYQ,cAAc,CAAC;AAACjC,gBAAAA,QAAAA;AAAU,gBAAA;aAAS,EAAE;gBAAEkC,MAAQ,EAAA;AAAK,aAAA,CAAA;AAChET,YAAAA,WAAAA,CAAYQ,cAAc,CAAC;AAACjC,gBAAAA,QAAAA;AAAU,gBAAA;aAAc,EAAE;gBAAEkC,MAAQ,EAAA;AAAK,aAAA,CAAA;AACvE;AACF,KAAA,CAAA;AAGF,IAAA,MAAMC,SAAS,CAACjC,KAAAA,EAAcC,QAC5B2B,GAAAA,QAAAA,CAASM,WAAW,CAAC;AAAElC,YAAAA,KAAAA;AAAOC,YAAAA;AAAS,SAAA,CAAA;IAEzC,MAAMkC,MAAAA,GAAS,IAAMV,eAAAA,CAAgBW,KAAK,EAAA;IAE1C,OAAO;AACLH,QAAAA,MAAAA;AACAI,QAAAA,SAAAA,EAAWT,SAASS,SAAS;AAC7BF,QAAAA,MAAAA;AACAG,QAAAA,KAAAA,EAAOV,SAASU,KAAK;AACrBnB,QAAAA,QAAAA;AACAoB,QAAAA,MAAAA,EAAQX,SAASW;AACnB,KAAA;AACF;;;;"}