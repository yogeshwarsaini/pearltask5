{"version":3,"file":"index.mjs","sources":["../../../../server/src/services/extensions/index.ts"],"sourcesContent":["import { async } from '@strapi/utils';\nimport { signEntityMedia } from './utils';\n\nconst signFileUrlsOnDocumentService = async () => {\n  const { provider } = strapi.plugins.upload;\n  const isPrivate = await provider.isPrivate();\n\n  // We only need to sign the file urls if the provider is private\n  if (!isPrivate) {\n    return;\n  }\n\n  strapi.documents.use(async (ctx, next) => {\n    const uid = ctx.uid;\n    const result: any = await next();\n\n    if (ctx.action === 'findMany') {\n      // Shape: [ entry ]\n      return async.map(result, (entry: any) => signEntityMedia(entry, uid));\n    }\n\n    if (\n      ctx.action === 'findFirst' ||\n      ctx.action === 'findOne' ||\n      ctx.action === 'create' ||\n      ctx.action === 'update'\n    ) {\n      // Shape: entry\n      return signEntityMedia(result, uid);\n    }\n\n    if (\n      ctx.action === 'delete' ||\n      ctx.action === 'clone' ||\n      ctx.action === 'publish' ||\n      ctx.action === 'unpublish' ||\n      ctx.action === 'discardDraft'\n    ) {\n      // Shape: { entries: [ entry ] }\n      // ...\n      return {\n        ...result,\n        entries: await async.map(result.entries, (entry: any) => signEntityMedia(entry, uid)),\n      };\n    }\n\n    return result;\n  });\n};\n\nexport default {\n  signFileUrlsOnDocumentService,\n};\n"],"names":["signFileUrlsOnDocumentService","provider","strapi","plugins","upload","isPrivate","documents","use","ctx","next","uid","result","action","async","map","entry","signEntityMedia","entries"],"mappings":";;;AAGA,MAAMA,6BAAgC,GAAA,UAAA;AACpC,IAAA,MAAM,EAAEC,QAAQ,EAAE,GAAGC,MAAOC,CAAAA,OAAO,CAACC,MAAM;IAC1C,MAAMC,SAAAA,GAAY,MAAMJ,QAAAA,CAASI,SAAS,EAAA;;AAG1C,IAAA,IAAI,CAACA,SAAW,EAAA;AACd,QAAA;AACF;AAEAH,IAAAA,MAAAA,CAAOI,SAAS,CAACC,GAAG,CAAC,OAAOC,GAAKC,EAAAA,IAAAA,GAAAA;QAC/B,MAAMC,GAAAA,GAAMF,IAAIE,GAAG;AACnB,QAAA,MAAMC,SAAc,MAAMF,IAAAA,EAAAA;QAE1B,IAAID,GAAAA,CAAII,MAAM,KAAK,UAAY,EAAA;;AAE7B,YAAA,OAAOC,MAAMC,GAAG,CAACH,QAAQ,CAACI,KAAAA,GAAeC,gBAAgBD,KAAOL,EAAAA,GAAAA,CAAAA,CAAAA;AAClE;AAEA,QAAA,IACEF,GAAII,CAAAA,MAAM,KAAK,WAAA,IACfJ,IAAII,MAAM,KAAK,SACfJ,IAAAA,GAAAA,CAAII,MAAM,KAAK,QAAA,IACfJ,GAAII,CAAAA,MAAM,KAAK,QACf,EAAA;;AAEA,YAAA,OAAOI,gBAAgBL,MAAQD,EAAAA,GAAAA,CAAAA;AACjC;AAEA,QAAA,IACEF,IAAII,MAAM,KAAK,YACfJ,GAAII,CAAAA,MAAM,KAAK,OACfJ,IAAAA,GAAAA,CAAII,MAAM,KAAK,SAAA,IACfJ,IAAII,MAAM,KAAK,eACfJ,GAAII,CAAAA,MAAM,KAAK,cACf,EAAA;;;YAGA,OAAO;AACL,gBAAA,GAAGD,MAAM;gBACTM,OAAS,EAAA,MAAMJ,KAAMC,CAAAA,GAAG,CAACH,MAAAA,CAAOM,OAAO,EAAE,CAACF,KAAeC,GAAAA,eAAAA,CAAgBD,KAAOL,EAAAA,GAAAA,CAAAA;AAClF,aAAA;AACF;QAEA,OAAOC,MAAAA;AACT,KAAA,CAAA;AACF,CAAA;AAEA,iBAAe;AACbX,IAAAA;AACF,CAAE;;;;"}