{"version":3,"file":"upload.mjs","sources":["../../../server/src/services/upload.ts"],"sourcesContent":["import os from 'os';\nimport path from 'path';\nimport fs from 'fs';\nimport fse from 'fs-extra';\nimport _ from 'lodash';\nimport { extension } from 'mime-types';\nimport {\n  sanitize,\n  contentTypes as contentTypesUtils,\n  errors,\n  file as fileUtils,\n} from '@strapi/utils';\n\nimport type { Core, UID } from '@strapi/types';\n\nimport { FILE_MODEL_UID, ALLOWED_WEBHOOK_EVENTS } from '../constants';\nimport { getService } from '../utils';\n\nimport type { Config, File, InputFile, UploadableFile, FileInfo } from '../types';\nimport type { ViewConfiguration } from '../controllers/validation/admin/configureView';\nimport type { Settings } from '../controllers/validation/admin/settings';\n\ntype User = {\n  id: string | number;\n};\n\ntype ID = string | number;\n\ntype CommonOptions = {\n  user?: User;\n};\n\ntype Metas = {\n  refId?: ID;\n  ref?: string;\n  field?: string;\n  path?: string;\n  tmpWorkingDirectory?: string;\n};\n\nconst { UPDATED_BY_ATTRIBUTE, CREATED_BY_ATTRIBUTE } = contentTypesUtils.constants;\nconst { MEDIA_CREATE, MEDIA_UPDATE, MEDIA_DELETE } = ALLOWED_WEBHOOK_EVENTS;\n\nconst { ApplicationError, NotFoundError } = errors;\nconst { bytesToKbytes } = fileUtils;\n\nexport default ({ strapi }: { strapi: Core.Strapi }) => {\n  const sendMediaMetrics = (data: Pick<File, 'caption' | 'alternativeText'>) => {\n    if (_.has(data, 'caption') && !_.isEmpty(data.caption)) {\n      strapi.telemetry.send('didSaveMediaWithCaption');\n    }\n\n    if (_.has(data, 'alternativeText') && !_.isEmpty(data.alternativeText)) {\n      strapi.telemetry.send('didSaveMediaWithAlternativeText');\n    }\n  };\n\n  const createAndAssignTmpWorkingDirectoryToFiles = async (\n    files: InputFile | InputFile[]\n  ): Promise<string> => {\n    const tmpWorkingDirectory = await fse.mkdtemp(path.join(os.tmpdir(), 'strapi-upload-'));\n\n    if (Array.isArray(files)) {\n      files.forEach((file) => {\n        file.tmpWorkingDirectory = tmpWorkingDirectory;\n      });\n    } else {\n      files.tmpWorkingDirectory = tmpWorkingDirectory;\n    }\n\n    return tmpWorkingDirectory;\n  };\n\n  function filenameReservedRegex() {\n    // eslint-disable-next-line no-control-regex\n    return /[<>:\"/\\\\|?*\\u0000-\\u001F]/g;\n  }\n\n  function windowsReservedNameRegex() {\n    return /^(con|prn|aux|nul|com\\d|lpt\\d)$/i;\n  }\n\n  /**\n   * Copied from https://github.com/sindresorhus/valid-filename package\n   */\n  function isValidFilename(string: string) {\n    if (!string || string.length > 255) {\n      return false;\n    }\n    if (filenameReservedRegex().test(string) || windowsReservedNameRegex().test(string)) {\n      return false;\n    }\n    if (string === '.' || string === '..') {\n      return false;\n    }\n    return true;\n  }\n\n  async function emitEvent(event: string, data: Record<string, any>) {\n    const modelDef = strapi.getModel(FILE_MODEL_UID);\n    const sanitizedData = await sanitize.sanitizers.defaultSanitizeOutput(\n      {\n        schema: modelDef,\n        getModel(uid: string) {\n          return strapi.getModel(uid as UID.Schema);\n        },\n      },\n      data\n    );\n\n    strapi.eventHub.emit(event, { media: sanitizedData });\n  }\n\n  async function formatFileInfo(\n    { filename, type, size }: { filename: string; type: string; size: number },\n    fileInfo: Partial<FileInfo> = {},\n    metas: {\n      refId?: ID;\n      ref?: string;\n      field?: string;\n      path?: string;\n      tmpWorkingDirectory?: string;\n    } = {}\n  ): Promise<Omit<UploadableFile, 'getStream'>> {\n    const fileService = getService('file');\n    const imageManipulationService = getService('image-manipulation');\n\n    if (!isValidFilename(filename)) {\n      throw new ApplicationError('File name contains invalid characters');\n    }\n\n    let ext = path.extname(filename);\n    if (!ext) {\n      ext = `.${extension(type)}`;\n    }\n    const usedName = (fileInfo.name || filename).normalize();\n    const basename = path.basename(usedName, ext);\n\n    // Prevent null characters in file name\n    if (!isValidFilename(filename)) {\n      throw new ApplicationError('File name contains invalid characters');\n    }\n\n    const entity: Omit<UploadableFile, 'getStream'> = {\n      name: usedName,\n      alternativeText: fileInfo.alternativeText,\n      caption: fileInfo.caption,\n      folder: fileInfo.folder,\n      folderPath: await fileService.getFolderPath(fileInfo.folder),\n      hash: imageManipulationService.generateFileName(basename),\n      ext,\n      mime: type,\n      size: bytesToKbytes(size),\n      sizeInBytes: size,\n    };\n\n    const { refId, ref, field } = metas;\n\n    if (refId && ref && field) {\n      entity.related = [\n        {\n          id: refId,\n          __type: ref,\n          __pivot: { field },\n        },\n      ];\n    }\n\n    if (metas.path) {\n      entity.path = metas.path;\n    }\n\n    if (metas.tmpWorkingDirectory) {\n      entity.tmpWorkingDirectory = metas.tmpWorkingDirectory;\n    }\n\n    return entity;\n  }\n\n  async function enhanceAndValidateFile(\n    file: InputFile,\n    fileInfo: FileInfo,\n    metas?: Metas\n  ): Promise<UploadableFile> {\n    const currentFile = (await formatFileInfo(\n      {\n        filename: file.originalFilename ?? 'unamed',\n        type: file.mimetype ?? 'application/octet-stream',\n        size: file.size,\n      },\n      fileInfo,\n      {\n        ...metas,\n        tmpWorkingDirectory: file.tmpWorkingDirectory,\n      }\n    )) as UploadableFile;\n\n    currentFile.filepath = file.filepath;\n    currentFile.getStream = () => fs.createReadStream(file.filepath);\n\n    const { optimize, isImage, isFaultyImage, isOptimizableImage } = strapi\n      .plugin('upload')\n      .service('image-manipulation');\n\n    if (await isImage(currentFile)) {\n      if (await isFaultyImage(currentFile)) {\n        throw new ApplicationError('File is not a valid image');\n      }\n      if (await isOptimizableImage(currentFile)) {\n        return optimize(currentFile);\n      }\n    }\n\n    return currentFile;\n  }\n\n  async function upload(\n    {\n      data,\n      files,\n    }: {\n      data: Record<string, unknown>;\n      files: InputFile | InputFile[];\n    },\n    opts?: CommonOptions\n  ) {\n    const { user } = opts ?? {};\n    // create temporary folder to store files for stream manipulation\n    const tmpWorkingDirectory = await createAndAssignTmpWorkingDirectoryToFiles(files);\n\n    let uploadedFiles: any[] = [];\n\n    try {\n      const { fileInfo, ...metas } = data;\n\n      const fileArray = Array.isArray(files) ? files : [files];\n      const fileInfoArray = Array.isArray(fileInfo) ? fileInfo : [fileInfo];\n\n      const doUpload = async (file: InputFile, fileInfo: FileInfo) => {\n        const fileData = await enhanceAndValidateFile(file, fileInfo, metas);\n        return uploadFileAndPersist(fileData, { user });\n      };\n\n      uploadedFiles = await Promise.all(\n        fileArray.map((file, idx) => doUpload(file, fileInfoArray[idx] || {}))\n      );\n    } finally {\n      // delete temporary folder\n      await fse.remove(tmpWorkingDirectory);\n    }\n\n    return uploadedFiles;\n  }\n\n  /**\n   * When uploading an image, an additional thumbnail is generated.\n   * Also, if there are responsive formats defined, another set of images will be generated too.\n   *\n   * @param {*} fileData\n   */\n  async function uploadImage(fileData: UploadableFile) {\n    const { getDimensions, generateThumbnail, generateResponsiveFormats, isResizableImage } =\n      getService('image-manipulation');\n\n    // Store width and height of the original image\n    const { width, height } = await getDimensions(fileData);\n\n    // Make sure this is assigned before calling any upload\n    // That way it can mutate the width and height\n    _.assign(fileData, {\n      width,\n      height,\n    });\n\n    // For performance reasons, all uploads are wrapped in a single Promise.all\n    const uploadThumbnail = async (thumbnailFile: UploadableFile) => {\n      await getService('provider').upload(thumbnailFile);\n      _.set(fileData, 'formats.thumbnail', thumbnailFile);\n    };\n\n    // Generate thumbnail and responsive formats\n    const uploadResponsiveFormat = async (format: { key: string; file: UploadableFile }) => {\n      const { key, file } = format;\n      await getService('provider').upload(file);\n      _.set(fileData, ['formats', key], file);\n    };\n\n    const uploadPromises: Promise<void>[] = [];\n\n    // Upload image\n    uploadPromises.push(getService('provider').upload(fileData));\n\n    // Generate & Upload thumbnail and responsive formats\n    if (await isResizableImage(fileData)) {\n      const thumbnailFile = await generateThumbnail(fileData);\n      if (thumbnailFile) {\n        uploadPromises.push(uploadThumbnail(thumbnailFile));\n      }\n\n      const formats = await generateResponsiveFormats(fileData);\n      if (Array.isArray(formats) && formats.length > 0) {\n        for (const format of formats) {\n          // eslint-disable-next-line no-continue\n          if (!format) continue;\n          uploadPromises.push(uploadResponsiveFormat(format));\n        }\n      }\n    }\n    // Wait for all uploads to finish\n    await Promise.all(uploadPromises);\n  }\n\n  /**\n   * Upload a file. If it is an image it will generate a thumbnail\n   * and responsive formats (if enabled).\n   */\n  async function uploadFileAndPersist(fileData: UploadableFile, opts?: CommonOptions) {\n    const { user } = opts ?? {};\n\n    const config = strapi.config.get<Config>('plugin::upload');\n    const { isImage } = getService('image-manipulation');\n\n    await getService('provider').checkFileSize(fileData);\n\n    if (await isImage(fileData)) {\n      await uploadImage(fileData);\n    } else {\n      await getService('provider').upload(fileData);\n    }\n\n    _.set(fileData, 'provider', config.provider);\n\n    // Persist file(s)\n    return add(fileData, { user });\n  }\n\n  async function updateFileInfo(\n    id: ID,\n    { name, alternativeText, caption, folder }: FileInfo,\n    opts?: CommonOptions\n  ) {\n    const { user } = opts ?? {};\n\n    const dbFile = await findOne(id);\n\n    if (!dbFile) {\n      throw new NotFoundError();\n    }\n\n    const fileService = getService('file');\n\n    const newName = _.isNil(name) ? dbFile.name : name;\n    const newInfos = {\n      name: newName,\n      alternativeText: _.isNil(alternativeText) ? dbFile.alternativeText : alternativeText,\n      caption: _.isNil(caption) ? dbFile.caption : caption,\n      folder: _.isUndefined(folder) ? dbFile.folder : folder,\n      folderPath: _.isUndefined(folder) ? dbFile.path : await fileService.getFolderPath(folder),\n    };\n\n    return update(id, newInfos, { user });\n  }\n\n  async function replace(\n    id: ID,\n    { data, file }: { data: { fileInfo: FileInfo }; file: InputFile },\n    opts?: CommonOptions\n  ) {\n    const { user } = opts ?? {};\n\n    const config = strapi.config.get<Config>('plugin::upload');\n\n    const { isImage } = getService('image-manipulation');\n\n    const dbFile = await findOne(id);\n    if (!dbFile) {\n      throw new NotFoundError();\n    }\n\n    // create temporary folder to store files for stream manipulation\n    const tmpWorkingDirectory = await createAndAssignTmpWorkingDirectoryToFiles(file);\n\n    let fileData: UploadableFile;\n\n    try {\n      const { fileInfo } = data;\n      fileData = await enhanceAndValidateFile(file, fileInfo);\n\n      // keep a constant hash and extension so the file url doesn't change when the file is replaced\n      _.assign(fileData, {\n        hash: dbFile.hash,\n        ext: dbFile.ext,\n      });\n\n      // execute delete function of the provider\n      if (dbFile.provider === config.provider) {\n        await strapi.plugin('upload').provider.delete(dbFile);\n\n        if (dbFile.formats) {\n          await Promise.all(\n            Object.keys(dbFile.formats).map((key) => {\n              return strapi.plugin('upload').provider.delete(dbFile.formats[key]);\n            })\n          );\n        }\n      }\n\n      // clear old formats\n      _.set(fileData, 'formats', {});\n\n      if (await isImage(fileData)) {\n        await uploadImage(fileData);\n      } else {\n        await getService('provider').upload(fileData);\n      }\n\n      _.set(fileData, 'provider', config.provider);\n    } finally {\n      // delete temporary folder\n      await fse.remove(tmpWorkingDirectory);\n    }\n\n    return update(id, fileData, { user });\n  }\n\n  async function update(id: ID, values: Partial<File>, opts?: CommonOptions) {\n    const { user } = opts ?? {};\n\n    const fileValues = { ...values };\n    if (user) {\n      Object.assign(fileValues, {\n        [UPDATED_BY_ATTRIBUTE]: user.id,\n      });\n    }\n\n    sendMediaMetrics(fileValues);\n\n    const res = await strapi.db.query(FILE_MODEL_UID).update({ where: { id }, data: fileValues });\n\n    await emitEvent(MEDIA_UPDATE, res);\n\n    return res;\n  }\n\n  async function add(values: any, opts?: CommonOptions) {\n    const { user } = opts ?? {};\n\n    const fileValues = { ...values };\n    if (user) {\n      Object.assign(fileValues, {\n        [UPDATED_BY_ATTRIBUTE]: user.id,\n        [CREATED_BY_ATTRIBUTE]: user.id,\n      });\n    }\n\n    sendMediaMetrics(fileValues);\n\n    const res = await strapi.db.query(FILE_MODEL_UID).create({ data: fileValues });\n\n    await emitEvent(MEDIA_CREATE, res);\n\n    return res;\n  }\n\n  function findOne(id: ID, populate = {}) {\n    const query = strapi.get('query-params').transform(FILE_MODEL_UID, {\n      populate,\n    });\n\n    return strapi.db.query(FILE_MODEL_UID).findOne({\n      where: { id },\n      ...query,\n    });\n  }\n\n  function findMany(query: any = {}): Promise<File[]> {\n    return strapi.db\n      .query(FILE_MODEL_UID)\n      .findMany(strapi.get('query-params').transform(FILE_MODEL_UID, query));\n  }\n\n  function findPage(query: any = {}) {\n    return strapi.db\n      .query(FILE_MODEL_UID)\n      .findPage(strapi.get('query-params').transform(FILE_MODEL_UID, query));\n  }\n\n  async function remove(file: File) {\n    const config = strapi.config.get<Config>('plugin::upload');\n\n    // execute delete function of the provider\n    if (file.provider === config.provider) {\n      await strapi.plugin('upload').provider.delete(file);\n\n      if (file.formats) {\n        const keys = Object.keys(file.formats);\n\n        await Promise.all(\n          keys.map((key) => {\n            return strapi.plugin('upload').provider.delete(file.formats![key]);\n          })\n        );\n      }\n    }\n\n    const media = await strapi.db.query(FILE_MODEL_UID).findOne({\n      where: { id: file.id },\n    });\n\n    await emitEvent(MEDIA_DELETE, media);\n\n    return strapi.db.query(FILE_MODEL_UID).delete({ where: { id: file.id } });\n  }\n\n  async function getSettings() {\n    const res = await strapi.store!({ type: 'plugin', name: 'upload', key: 'settings' }).get({});\n\n    return res as Settings | null;\n  }\n\n  function setSettings(value: Settings) {\n    if (value.responsiveDimensions === true) {\n      strapi.telemetry.send('didEnableResponsiveDimensions');\n    } else {\n      strapi.telemetry.send('didDisableResponsiveDimensions');\n    }\n\n    return strapi.store!({ type: 'plugin', name: 'upload', key: 'settings' }).set({ value });\n  }\n\n  async function getConfiguration() {\n    const res = await strapi.store!({\n      type: 'plugin',\n      name: 'upload',\n      key: 'view_configuration',\n    }).get({});\n\n    return res as ViewConfiguration | null;\n  }\n\n  function setConfiguration(value: ViewConfiguration) {\n    return strapi.store!({ type: 'plugin', name: 'upload', key: 'view_configuration' }).set({\n      value,\n    });\n  }\n\n  return {\n    formatFileInfo,\n    upload,\n    updateFileInfo,\n    replace,\n    findOne,\n    findMany,\n    findPage,\n    remove,\n    getSettings,\n    setSettings,\n    getConfiguration,\n    setConfiguration,\n\n    /**\n     * exposed for testing only\n     * @internal\n     */\n    _uploadImage: uploadImage,\n  };\n};\n"],"names":["UPDATED_BY_ATTRIBUTE","CREATED_BY_ATTRIBUTE","contentTypesUtils","constants","MEDIA_CREATE","MEDIA_UPDATE","MEDIA_DELETE","ALLOWED_WEBHOOK_EVENTS","ApplicationError","NotFoundError","errors","bytesToKbytes","fileUtils","strapi","sendMediaMetrics","data","_","has","isEmpty","caption","telemetry","send","alternativeText","createAndAssignTmpWorkingDirectoryToFiles","files","tmpWorkingDirectory","fse","mkdtemp","path","join","os","tmpdir","Array","isArray","forEach","file","filenameReservedRegex","windowsReservedNameRegex","isValidFilename","string","length","test","emitEvent","event","modelDef","getModel","FILE_MODEL_UID","sanitizedData","sanitize","sanitizers","defaultSanitizeOutput","schema","uid","eventHub","emit","media","formatFileInfo","filename","type","size","fileInfo","metas","fileService","getService","imageManipulationService","ext","extname","extension","usedName","name","normalize","basename","entity","folder","folderPath","getFolderPath","hash","generateFileName","mime","sizeInBytes","refId","ref","field","related","id","__type","__pivot","enhanceAndValidateFile","currentFile","originalFilename","mimetype","filepath","getStream","fs","createReadStream","optimize","isImage","isFaultyImage","isOptimizableImage","plugin","service","upload","opts","user","uploadedFiles","fileArray","fileInfoArray","doUpload","fileData","uploadFileAndPersist","Promise","all","map","idx","remove","uploadImage","getDimensions","generateThumbnail","generateResponsiveFormats","isResizableImage","width","height","assign","uploadThumbnail","thumbnailFile","set","uploadResponsiveFormat","format","key","uploadPromises","push","formats","config","get","checkFileSize","provider","add","updateFileInfo","dbFile","findOne","newName","isNil","newInfos","isUndefined","update","replace","delete","Object","keys","values","fileValues","res","db","query","where","create","populate","transform","findMany","findPage","getSettings","store","setSettings","value","responsiveDimensions","getConfiguration","setConfiguration","_uploadImage"],"mappings":"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"}