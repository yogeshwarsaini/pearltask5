{"version":3,"file":"find-entity-and-check-permissions.mjs","sources":["../../../../server/src/controllers/utils/find-entity-and-check-permissions.ts"],"sourcesContent":["import _ from 'lodash';\nimport { errors, contentTypes as contentTypesUtils } from '@strapi/utils';\nimport { getService } from '../../utils';\n\nconst findEntityAndCheckPermissions = async (\n  ability: unknown,\n  action: string,\n  model: string,\n  id: string | number\n) => {\n  const file = await getService('upload').findOne(id, [\n    contentTypesUtils.constants.CREATED_BY_ATTRIBUTE,\n    'folder',\n  ]);\n\n  if (_.isNil(file)) {\n    throw new errors.NotFoundError();\n  }\n\n  const pm = strapi\n    .service('admin::permission')\n    .createPermissionsManager({ ability, action, model });\n\n  const creatorId = _.get(file, [contentTypesUtils.constants.CREATED_BY_ATTRIBUTE, 'id']);\n  const author = creatorId\n    ? await strapi.service('admin::user').findOne(creatorId, ['roles'])\n    : null;\n\n  const fileWithRoles = _.set(_.cloneDeep(file), 'createdBy', author);\n\n  if (pm.ability.cannot(pm.action, pm.toSubject(fileWithRoles))) {\n    throw new errors.ForbiddenError();\n  }\n\n  return { pm, file };\n};\n\nexport { findEntityAndCheckPermissions };\n"],"names":["findEntityAndCheckPermissions","ability","action","model","id","file","getService","findOne","contentTypesUtils","constants","CREATED_BY_ATTRIBUTE","_","isNil","errors","NotFoundError","pm","strapi","service","createPermissionsManager","creatorId","get","author","fileWithRoles","set","cloneDeep","cannot","toSubject","ForbiddenError"],"mappings":";;;;AAIA,MAAMA,6BAAgC,GAAA,OACpCC,OACAC,EAAAA,MAAAA,EACAC,KACAC,EAAAA,EAAAA,GAAAA;AAEA,IAAA,MAAMC,OAAO,MAAMC,UAAAA,CAAW,QAAUC,CAAAA,CAAAA,OAAO,CAACH,EAAI,EAAA;QAClDI,YAAkBC,CAAAA,SAAS,CAACC,oBAAoB;AAChD,QAAA;AACD,KAAA,CAAA;IAED,IAAIC,CAAAA,CAAEC,KAAK,CAACP,IAAO,CAAA,EAAA;QACjB,MAAM,IAAIQ,OAAOC,aAAa,EAAA;AAChC;AAEA,IAAA,MAAMC,KAAKC,MACRC,CAAAA,OAAO,CAAC,mBAAA,CAAA,CACRC,wBAAwB,CAAC;AAAEjB,QAAAA,OAAAA;AAASC,QAAAA,MAAAA;AAAQC,QAAAA;AAAM,KAAA,CAAA;AAErD,IAAA,MAAMgB,SAAYR,GAAAA,CAAAA,CAAES,GAAG,CAACf,IAAM,EAAA;QAACG,YAAkBC,CAAAA,SAAS,CAACC,oBAAoB;AAAE,QAAA;AAAK,KAAA,CAAA;IACtF,MAAMW,MAAAA,GAASF,YACX,MAAMH,MAAAA,CAAOC,OAAO,CAAC,aAAA,CAAA,CAAeV,OAAO,CAACY,SAAW,EAAA;AAAC,QAAA;KAAQ,CAChE,GAAA,IAAA;IAEJ,MAAMG,aAAAA,GAAgBX,EAAEY,GAAG,CAACZ,EAAEa,SAAS,CAACnB,OAAO,WAAagB,EAAAA,MAAAA,CAAAA;IAE5D,IAAIN,EAAAA,CAAGd,OAAO,CAACwB,MAAM,CAACV,EAAGb,CAAAA,MAAM,EAAEa,EAAAA,CAAGW,SAAS,CAACJ,aAAiB,CAAA,CAAA,EAAA;QAC7D,MAAM,IAAIT,OAAOc,cAAc,EAAA;AACjC;IAEA,OAAO;AAAEZ,QAAAA,EAAAA;AAAIV,QAAAA;AAAK,KAAA;AACpB;;;;"}