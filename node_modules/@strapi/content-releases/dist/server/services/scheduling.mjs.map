{"version":3,"file":"scheduling.mjs","sources":["../../../server/src/services/scheduling.ts"],"sourcesContent":["import { scheduleJob, Job } from 'node-schedule';\nimport type { Core } from '@strapi/types';\n\nimport { errors } from '@strapi/utils';\nimport { Release } from '../../../shared/contracts/releases';\nimport { getService } from '../utils';\nimport { RELEASE_MODEL_UID } from '../constants';\n\nconst createSchedulingService = ({ strapi }: { strapi: Core.Strapi }) => {\n  const scheduledJobs = new Map<Release['id'], Job>();\n\n  return {\n    async set(releaseId: Release['id'], scheduleDate: Date) {\n      const release = await strapi.db\n        .query(RELEASE_MODEL_UID)\n        .findOne({ where: { id: releaseId, releasedAt: null } });\n\n      if (!release) {\n        throw new errors.NotFoundError(`No release found for id ${releaseId}`);\n      }\n\n      const job = scheduleJob(scheduleDate, async () => {\n        try {\n          await getService('release', { strapi }).publish(releaseId);\n          // @TODO: Trigger webhook with success message\n        } catch (error) {\n          // @TODO: Trigger webhook with error message\n        }\n\n        this.cancel(releaseId);\n      });\n\n      if (scheduledJobs.has(releaseId)) {\n        this.cancel(releaseId);\n      }\n\n      scheduledJobs.set(releaseId, job);\n\n      return scheduledJobs;\n    },\n\n    cancel(releaseId: Release['id']) {\n      if (scheduledJobs.has(releaseId)) {\n        scheduledJobs.get(releaseId)!.cancel();\n        scheduledJobs.delete(releaseId);\n      }\n\n      return scheduledJobs;\n    },\n\n    getAll() {\n      return scheduledJobs;\n    },\n\n    /**\n     * On bootstrap, we can use this function to make sure to sync the scheduled jobs from the database that are not yet released\n     * This is useful in case the server was restarted and the scheduled jobs were lost\n     * This also could be used to sync different Strapi instances in case of a cluster\n     */\n    async syncFromDatabase() {\n      const releases = await strapi.db.query(RELEASE_MODEL_UID).findMany({\n        where: {\n          scheduledAt: {\n            $gte: new Date(),\n          },\n          releasedAt: null,\n        },\n      });\n\n      for (const release of releases) {\n        this.set(release.id, release.scheduledAt);\n      }\n\n      return scheduledJobs;\n    },\n  };\n};\n\nexport default createSchedulingService;\n"],"names":["createSchedulingService","strapi","scheduledJobs","Map","set","releaseId","scheduleDate","release","db","query","RELEASE_MODEL_UID","findOne","where","id","releasedAt","errors","NotFoundError","job","scheduleJob","getService","publish","error","cancel","has","get","delete","getAll","syncFromDatabase","releases","findMany","scheduledAt","$gte","Date"],"mappings":";;;;;AAQA,MAAMA,uBAA0B,GAAA,CAAC,EAAEC,MAAM,EAA2B,GAAA;AAClE,IAAA,MAAMC,gBAAgB,IAAIC,GAAAA,EAAAA;IAE1B,OAAO;QACL,MAAMC,GAAAA,CAAAA,CAAIC,SAAwB,EAAEC,YAAkB,EAAA;YACpD,MAAMC,OAAAA,GAAU,MAAMN,MAAOO,CAAAA,EAAE,CAC5BC,KAAK,CAACC,iBACNC,CAAAA,CAAAA,OAAO,CAAC;gBAAEC,KAAO,EAAA;oBAAEC,EAAIR,EAAAA,SAAAA;oBAAWS,UAAY,EAAA;AAAK;AAAE,aAAA,CAAA;AAExD,YAAA,IAAI,CAACP,OAAS,EAAA;gBACZ,MAAM,IAAIQ,OAAOC,aAAa,CAAC,CAAC,wBAAwB,EAAEX,UAAU,CAAC,CAAA;AACvE;YAEA,MAAMY,GAAAA,GAAMC,YAAYZ,YAAc,EAAA,UAAA;gBACpC,IAAI;AACF,oBAAA,MAAMa,WAAW,SAAW,EAAA;AAAElB,wBAAAA;AAAO,qBAAA,CAAA,CAAGmB,OAAO,CAACf,SAAAA,CAAAA;;AAElD,iBAAA,CAAE,OAAOgB,KAAO,EAAA;;AAEhB;gBAEA,IAAI,CAACC,MAAM,CAACjB,SAAAA,CAAAA;AACd,aAAA,CAAA;YAEA,IAAIH,aAAAA,CAAcqB,GAAG,CAAClB,SAAY,CAAA,EAAA;gBAChC,IAAI,CAACiB,MAAM,CAACjB,SAAAA,CAAAA;AACd;YAEAH,aAAcE,CAAAA,GAAG,CAACC,SAAWY,EAAAA,GAAAA,CAAAA;YAE7B,OAAOf,aAAAA;AACT,SAAA;AAEAoB,QAAAA,MAAAA,CAAAA,CAAOjB,SAAwB,EAAA;YAC7B,IAAIH,aAAAA,CAAcqB,GAAG,CAAClB,SAAY,CAAA,EAAA;gBAChCH,aAAcsB,CAAAA,GAAG,CAACnB,SAAAA,CAAAA,CAAYiB,MAAM,EAAA;AACpCpB,gBAAAA,aAAAA,CAAcuB,MAAM,CAACpB,SAAAA,CAAAA;AACvB;YAEA,OAAOH,aAAAA;AACT,SAAA;AAEAwB,QAAAA,MAAAA,CAAAA,GAAAA;YACE,OAAOxB,aAAAA;AACT,SAAA;AAEA;;;;AAIC,QACD,MAAMyB,gBAAAA,CAAAA,GAAAA;YACJ,MAAMC,QAAAA,GAAW,MAAM3B,MAAOO,CAAAA,EAAE,CAACC,KAAK,CAACC,iBAAmBmB,CAAAA,CAAAA,QAAQ,CAAC;gBACjEjB,KAAO,EAAA;oBACLkB,WAAa,EAAA;AACXC,wBAAAA,IAAAA,EAAM,IAAIC,IAAAA;AACZ,qBAAA;oBACAlB,UAAY,EAAA;AACd;AACF,aAAA,CAAA;YAEA,KAAK,MAAMP,WAAWqB,QAAU,CAAA;AAC9B,gBAAA,IAAI,CAACxB,GAAG,CAACG,QAAQM,EAAE,EAAEN,QAAQuB,WAAW,CAAA;AAC1C;YAEA,OAAO5B,aAAAA;AACT;AACF,KAAA;AACF;;;;"}