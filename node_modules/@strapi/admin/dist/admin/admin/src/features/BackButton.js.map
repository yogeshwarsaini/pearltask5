{"version":3,"file":"BackButton.js","sources":["../../../../../admin/src/features/BackButton.tsx"],"sourcesContent":["import * as React from 'react';\n\nimport { Link, LinkProps } from '@strapi/design-system';\nimport { ArrowLeft } from '@strapi/icons';\nimport { produce } from 'immer';\nimport { useIntl } from 'react-intl';\nimport { NavLink, type To, useLocation, useNavigate, useNavigationType } from 'react-router-dom';\n\nimport { createContext } from '../components/Context';\n\n/* -------------------------------------------------------------------------------------------------\n * HistoryProvider\n * -----------------------------------------------------------------------------------------------*/\ninterface HistoryState {\n  /**\n   * The history of the user's navigation within our application\n   * during their current session.\n   */\n  history: string[];\n  /**\n   * The index of the current location in the history array.\n   */\n  currentLocationIndex: number;\n  /**\n   * The current location of the user within our application.\n   */\n  currentLocation: string;\n  /**\n   * Whether the user can go back in the history.\n   */\n  canGoBack: boolean;\n}\n\ninterface HistoryContextValue extends HistoryState {\n  /**\n   * @description Push a new state to the history. You can\n   * either pass a string or an object.\n   */\n  pushState: (\n    path:\n      | {\n          to: string;\n          search: string;\n        }\n      | string\n  ) => void;\n  /**\n   * @description Go back in the history. This calls `navigate(-1)` internally\n   * to keep the browser in sync with the application state.\n   */\n  goBack: () => void;\n}\n\nconst [Provider, useHistory] = createContext<HistoryContextValue>('History', {\n  history: [],\n  currentLocationIndex: 0,\n  currentLocation: '',\n  canGoBack: false,\n  pushState: () => {\n    throw new Error('You must use the `HistoryProvider` to access the `pushState` function.');\n  },\n  goBack: () => {\n    throw new Error('You must use the `HistoryProvider` to access the `goBack` function.');\n  },\n});\n\ninterface HistoryProviderProps {\n  children: React.ReactNode;\n}\n\nconst HistoryProvider = ({ children }: HistoryProviderProps) => {\n  const location = useLocation();\n  const navigationType = useNavigationType();\n  const navigate = useNavigate();\n  const [state, dispatch] = React.useReducer(reducer, {\n    history: [],\n    currentLocationIndex: 0,\n    currentLocation: '',\n    canGoBack: false,\n  });\n\n  const isGoingBack = React.useRef(false);\n\n  const pushState: HistoryContextValue['pushState'] = React.useCallback((path) => {\n    dispatch({\n      type: 'PUSH_STATE',\n      payload: typeof path === 'string' ? { to: path, search: '' } : path,\n    });\n  }, []);\n\n  const goBack: HistoryContextValue['goBack'] = React.useCallback(() => {\n    /**\n     * Perform the browser back action, dispatch the goBack action to keep the state in sync\n     * and set the ref to avoid an infinite loop and incorrect state pushing\n     */\n    navigate(-1);\n    dispatch({ type: 'GO_BACK' });\n    isGoingBack.current = true;\n  }, [navigate]);\n\n  /**\n   * This is a semi-listener pattern to keep the `canGoBack` state in sync.\n   */\n  const prevIndex = React.useRef(state.currentLocationIndex);\n  React.useEffect(() => {\n    if (state.currentLocationIndex !== prevIndex.current) {\n      dispatch({\n        type: 'SET_CAN_GO_BACK',\n        payload: state.currentLocationIndex > 1 && state.history.length > 1,\n      });\n      prevIndex.current = state.currentLocationIndex;\n    }\n  }, [prevIndex, state.currentLocationIndex, state.history.length]);\n\n  /**\n   * This effect is responsible for pushing the new state to the history\n   * when the user navigates to a new location assuming they're not going back.\n   */\n  React.useLayoutEffect(() => {\n    if (isGoingBack.current) {\n      isGoingBack.current = false;\n    } else if (navigationType === 'REPLACE') {\n      // Prevent appending to the history when the location changes via a replace:true navigation\n      dispatch({\n        type: 'REPLACE_STATE',\n        payload: { to: location.pathname, search: location.search },\n      });\n    } else {\n      // this should only occur on link movements, not back/forward clicks\n      dispatch({\n        type: 'PUSH_STATE',\n        payload: { to: location.pathname, search: location.search },\n      });\n    }\n  }, [dispatch, location.pathname, location.search, navigationType]);\n\n  return (\n    <Provider pushState={pushState} goBack={goBack} {...state}>\n      {children}\n    </Provider>\n  );\n};\n\ntype HistoryActions =\n  | {\n      type: 'PUSH_STATE';\n      payload: {\n        to: string;\n        search: string;\n      };\n    }\n  | {\n      type: 'REPLACE_STATE';\n      payload: {\n        to: string;\n        search: string;\n      };\n    }\n  | {\n      type: 'GO_BACK';\n    }\n  | {\n      type: 'SET_CAN_GO_BACK';\n      payload: boolean;\n    };\n\nconst reducer = (state: HistoryState, action: HistoryActions) =>\n  produce(state, (draft) => {\n    switch (action.type) {\n      case 'PUSH_STATE': {\n        const path = `${action.payload.to}${action.payload.search}`;\n        if (state.currentLocationIndex === state.history.length) {\n          // add the new place\n          draft.history = [...state.history, path];\n        } else {\n          // delete all the history after the current place and then add the new place\n          draft.history = [...state.history.slice(0, state.currentLocationIndex), path];\n        }\n\n        draft.currentLocation = path;\n        draft.currentLocationIndex += 1;\n\n        break;\n      }\n      case 'REPLACE_STATE': {\n        const path = `${action.payload.to}${action.payload.search}`;\n        draft.history = [...state.history.slice(0, state.currentLocationIndex - 1), path];\n        draft.currentLocation = path;\n        break;\n      }\n      case 'GO_BACK': {\n        const newIndex = state.currentLocationIndex - 1;\n\n        draft.currentLocation = state.history[newIndex - 1];\n        draft.currentLocationIndex = newIndex;\n        break;\n      }\n      case 'SET_CAN_GO_BACK': {\n        draft.canGoBack = action.payload;\n        break;\n      }\n      default:\n        break;\n    }\n  });\n\n/* -------------------------------------------------------------------------------------------------\n * BackButton\n * -----------------------------------------------------------------------------------------------*/\ninterface BackButtonProps extends Pick<LinkProps, 'disabled'> {\n  fallback?: To;\n}\n\n/**\n * @beta\n * @description The universal back button for the Strapi application. This uses the internal history\n * context to navigate the user back to the previous location. It can be completely disabled in a\n * specific user case. When no history is available, you can provide a fallback destination,\n * otherwise the link will be disabled.\n */\nconst BackButton = React.forwardRef<HTMLAnchorElement, BackButtonProps>(\n  ({ disabled, fallback = '' }, ref) => {\n    const { formatMessage } = useIntl();\n    const navigate = useNavigate();\n\n    const canGoBack = useHistory('BackButton', (state) => state.canGoBack);\n    const goBack = useHistory('BackButton', (state) => state.goBack);\n    const history = useHistory('BackButton', (state) => state.history);\n    const currentLocationIndex = useHistory('BackButton', (state) => state.currentLocationIndex);\n    const hasFallback = fallback !== '';\n    const shouldBeDisabled = disabled || (!canGoBack && !hasFallback);\n\n    const handleClick = (e: React.MouseEvent<HTMLAnchorElement>) => {\n      e.preventDefault();\n\n      if (canGoBack) {\n        goBack();\n      } else if (hasFallback) {\n        navigate(fallback);\n      }\n    };\n\n    // The link destination from the history. Undefined if there is only 1 location in the history.\n    const historyTo = canGoBack ? history.at(currentLocationIndex - 2) : undefined;\n    // If no link destination from the history, use the fallback.\n    const toWithFallback = historyTo ?? fallback;\n\n    return (\n      <Link\n        ref={ref}\n        tag={NavLink}\n        to={toWithFallback}\n        onClick={handleClick}\n        disabled={shouldBeDisabled}\n        aria-disabled={shouldBeDisabled}\n        startIcon={<ArrowLeft />}\n      >\n        {formatMessage({\n          id: 'global.back',\n          defaultMessage: 'Back',\n        })}\n      </Link>\n    );\n  }\n);\n\nexport { BackButton, HistoryProvider, useHistory };\nexport type { BackButtonProps, HistoryProviderProps, HistoryContextValue, HistoryState };\n"],"names":["Provider","useHistory","createContext","history","currentLocationIndex","currentLocation","canGoBack","pushState","Error","goBack","HistoryProvider","children","location","useLocation","navigationType","useNavigationType","navigate","useNavigate","state","dispatch","React","useReducer","reducer","isGoingBack","useRef","useCallback","path","type","payload","to","search","current","prevIndex","useEffect","length","useLayoutEffect","pathname","_jsx","action","produce","draft","slice","newIndex","BackButton","forwardRef","disabled","fallback","ref","formatMessage","useIntl","hasFallback","shouldBeDisabled","handleClick","e","preventDefault","historyTo","at","undefined","toWithFallback","Link","tag","NavLink","onClick","aria-disabled","startIcon","ArrowLeft","id","defaultMessage"],"mappings":"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"}