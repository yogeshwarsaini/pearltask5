{"version":3,"file":"guided-tour.mjs","sources":["../../../../../server/src/services/guided-tour.ts"],"sourcesContent":["import { Core, Internal } from '@strapi/types';\nimport constants from './constants';\n\nexport type GuidedTourRequiredActions = {\n  didCreateContentTypeSchema: boolean;\n  didCreateContent: boolean;\n  didCreateApiToken: boolean;\n};\nexport type GuidedTourCompletedActions = keyof GuidedTourRequiredActions;\n\nconst DEFAULT_ATTIBUTES = [\n  'createdAt',\n  'updatedAt',\n  'publishedAt',\n  'createdBy',\n  'updatedBy',\n  'locale',\n  'localizations',\n];\n\nexport const createGuidedTourService = ({ strapi }: { strapi: Core.Strapi }) => {\n  const getCompletedActions = async () => {\n    // Check if any content-type schemas have been created on the api:: namespace\n    const contentTypeSchemaNames = Object.keys(strapi.contentTypes).filter((contentTypeUid) =>\n      contentTypeUid.startsWith('api::')\n    );\n    const contentTypeSchemaAttributes = contentTypeSchemaNames.map((uid) => {\n      const attributes = Object.keys(\n        strapi.contentType(uid as Internal.UID.ContentType).attributes\n      );\n      return attributes.filter((attribute) => !DEFAULT_ATTIBUTES.includes(attribute));\n    });\n    const didCreateContentTypeSchema = (() => {\n      if (contentTypeSchemaNames.length === 0) {\n        return false;\n      }\n      return contentTypeSchemaAttributes.some((attributes) => attributes.length > 0);\n    })();\n\n    // Check if any content has been created for content-types on the api:: namespace\n    const hasContent = await (async () => {\n      for (const name of contentTypeSchemaNames) {\n        const count = await strapi.documents(name as Internal.UID.ContentType).count({});\n\n        if (count > 0) return true;\n      }\n\n      return false;\n    })();\n    const didCreateContent = didCreateContentTypeSchema && hasContent;\n\n    // Check if any api tokens have been created besides the default ones\n    const createdApiTokens = await strapi\n      .documents('admin::api-token')\n      .findMany({ fields: ['name', 'description'] });\n    const didCreateApiToken = createdApiTokens.some((doc) =>\n      constants.DEFAULT_API_TOKENS.every(\n        (token) => token.name !== doc.name && token.description !== doc.description\n      )\n    );\n\n    // Compute an array of action names that have been completed\n    const requiredActions = {\n      didCreateContentTypeSchema,\n      didCreateContent,\n      didCreateApiToken,\n    };\n    const requiredActionNames = Object.keys(requiredActions) as Array<GuidedTourCompletedActions>;\n    const completedActions = requiredActionNames.filter((key) => requiredActions[key]);\n\n    return completedActions;\n  };\n\n  return {\n    getCompletedActions,\n  };\n};\n"],"names":["DEFAULT_ATTIBUTES","createGuidedTourService","strapi","getCompletedActions","contentTypeSchemaNames","Object","keys","contentTypes","filter","contentTypeUid","startsWith","contentTypeSchemaAttributes","map","uid","attributes","contentType","attribute","includes","didCreateContentTypeSchema","length","some","hasContent","name","count","documents","didCreateContent","createdApiTokens","findMany","fields","didCreateApiToken","doc","constants","DEFAULT_API_TOKENS","every","token","description","requiredActions","requiredActionNames","completedActions","key"],"mappings":";;AAUA,MAAMA,iBAAoB,GAAA;AACxB,IAAA,WAAA;AACA,IAAA,WAAA;AACA,IAAA,aAAA;AACA,IAAA,WAAA;AACA,IAAA,WAAA;AACA,IAAA,QAAA;AACA,IAAA;AACD,CAAA;AAEYC,MAAAA,uBAAAA,GAA0B,CAAC,EAAEC,MAAM,EAA2B,GAAA;AACzE,IAAA,MAAMC,mBAAsB,GAAA,UAAA;;AAE1B,QAAA,MAAMC,sBAAyBC,GAAAA,MAAAA,CAAOC,IAAI,CAACJ,MAAOK,CAAAA,YAAY,CAAEC,CAAAA,MAAM,CAAC,CAACC,cACtEA,GAAAA,cAAAA,CAAeC,UAAU,CAAC,OAAA,CAAA,CAAA;AAE5B,QAAA,MAAMC,2BAA8BP,GAAAA,sBAAAA,CAAuBQ,GAAG,CAAC,CAACC,GAAAA,GAAAA;YAC9D,MAAMC,UAAAA,GAAaT,OAAOC,IAAI,CAC5BJ,OAAOa,WAAW,CAACF,KAAiCC,UAAU,CAAA;YAEhE,OAAOA,UAAAA,CAAWN,MAAM,CAAC,CAACQ,YAAc,CAAChB,iBAAAA,CAAkBiB,QAAQ,CAACD,SAAAA,CAAAA,CAAAA;AACtE,SAAA,CAAA;QACA,MAAME,0BAAAA,GAA6B,CAAC,IAAA;YAClC,IAAId,sBAAAA,CAAuBe,MAAM,KAAK,CAAG,EAAA;gBACvC,OAAO,KAAA;AACT;AACA,YAAA,OAAOR,4BAA4BS,IAAI,CAAC,CAACN,UAAeA,GAAAA,UAAAA,CAAWK,MAAM,GAAG,CAAA,CAAA;SAC9E,GAAA;;QAGA,MAAME,UAAAA,GAAa,MAAO,CAAA,UAAA;YACxB,KAAK,MAAMC,QAAQlB,sBAAwB,CAAA;gBACzC,MAAMmB,KAAAA,GAAQ,MAAMrB,MAAOsB,CAAAA,SAAS,CAACF,IAAkCC,CAAAA,CAAAA,KAAK,CAAC,EAAC,CAAA;gBAE9E,IAAIA,KAAAA,GAAQ,GAAG,OAAO,IAAA;AACxB;YAEA,OAAO,KAAA;SACT,GAAA;AACA,QAAA,MAAME,mBAAmBP,0BAA8BG,IAAAA,UAAAA;;AAGvD,QAAA,MAAMK,mBAAmB,MAAMxB,MAAAA,CAC5BsB,SAAS,CAAC,kBAAA,CAAA,CACVG,QAAQ,CAAC;YAAEC,MAAQ,EAAA;AAAC,gBAAA,MAAA;AAAQ,gBAAA;AAAc;AAAC,SAAA,CAAA;QAC9C,MAAMC,iBAAAA,GAAoBH,iBAAiBN,IAAI,CAAC,CAACU,GAC/CC,GAAAA,SAAAA,CAAUC,kBAAkB,CAACC,KAAK,CAChC,CAACC,KAAUA,GAAAA,KAAAA,CAAMZ,IAAI,KAAKQ,GAAIR,CAAAA,IAAI,IAAIY,KAAMC,CAAAA,WAAW,KAAKL,GAAAA,CAAIK,WAAW,CAAA,CAAA;;AAK/E,QAAA,MAAMC,eAAkB,GAAA;AACtBlB,YAAAA,0BAAAA;AACAO,YAAAA,gBAAAA;AACAI,YAAAA;AACF,SAAA;QACA,MAAMQ,mBAAAA,GAAsBhC,MAAOC,CAAAA,IAAI,CAAC8B,eAAAA,CAAAA;QACxC,MAAME,gBAAAA,GAAmBD,oBAAoB7B,MAAM,CAAC,CAAC+B,GAAQH,GAAAA,eAAe,CAACG,GAAI,CAAA,CAAA;QAEjF,OAAOD,gBAAAA;AACT,KAAA;IAEA,OAAO;AACLnC,QAAAA;AACF,KAAA;AACF;;;;"}