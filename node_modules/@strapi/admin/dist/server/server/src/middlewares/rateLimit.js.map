{"version":3,"file":"rateLimit.js","sources":["../../../../../server/src/middlewares/rateLimit.ts"],"sourcesContent":["import type { Context, Next } from 'koa';\nimport path from 'path';\nimport utils from '@strapi/utils';\nimport { isString, has, toLower, get } from 'lodash/fp';\nimport type { Core } from '@strapi/types';\n\nconst { RateLimitError } = utils.errors;\n\nexport default (config: any, { strapi }: { strapi: Core.Strapi }) =>\n  async (ctx: Context, next: Next) => {\n    let rateLimitConfig = strapi.config.get('admin.rateLimit') as any;\n\n    if (!rateLimitConfig) {\n      rateLimitConfig = {\n        enabled: true,\n      };\n    }\n\n    if (!has('enabled', rateLimitConfig)) {\n      rateLimitConfig.enabled = true;\n    }\n\n    if (rateLimitConfig.enabled === true) {\n      // TODO: TS - Do the dynamic import\n      // eslint-disable-next-line @typescript-eslint/no-var-requires\n      const rateLimit = require('koa2-ratelimit').RateLimit;\n\n      const requestEmail = get('request.body.email')(ctx);\n      const userEmail = isString(requestEmail) ? requestEmail.toLowerCase() : 'unknownEmail';\n\n      const requestPath = isString(ctx.request.path)\n        ? toLower(path.normalize(ctx.request.path)).replace(/\\/$/, '')\n        : 'invalidPath';\n\n      const loadConfig = {\n        interval: { min: 5 },\n        max: 5,\n        prefixKey: `${userEmail}:${requestPath}:${ctx.request.ip}`,\n        handler() {\n          throw new RateLimitError();\n        },\n        ...rateLimitConfig,\n        ...config,\n      };\n\n      return rateLimit.middleware(loadConfig)(ctx, next);\n    }\n\n    return next();\n  };\n"],"names":["RateLimitError","utils","errors","config","strapi","ctx","next","rateLimitConfig","get","enabled","has","rateLimit","require","RateLimit","requestEmail","userEmail","isString","toLowerCase","requestPath","request","path","toLower","normalize","replace","loadConfig","interval","min","max","prefixKey","ip","handler","middleware"],"mappings":";;;;;;AAMA,MAAM,EAAEA,cAAc,EAAE,GAAGC,MAAMC,MAAM;AAEvC,gBAAe,CAAA,CAACC,MAAa,EAAA,EAAEC,MAAM,EAA2B,GAC9D,OAAOC,GAAcC,EAAAA,IAAAA,GAAAA;AACnB,QAAA,IAAIC,eAAkBH,GAAAA,MAAAA,CAAOD,MAAM,CAACK,GAAG,CAAC,iBAAA,CAAA;AAExC,QAAA,IAAI,CAACD,eAAiB,EAAA;YACpBA,eAAkB,GAAA;gBAChBE,OAAS,EAAA;AACX,aAAA;AACF;QAEA,IAAI,CAACC,MAAI,CAAA,SAAA,EAAWH,eAAkB,CAAA,EAAA;AACpCA,YAAAA,eAAAA,CAAgBE,OAAO,GAAG,IAAA;AAC5B;QAEA,IAAIF,eAAAA,CAAgBE,OAAO,KAAK,IAAM,EAAA;;;YAGpC,MAAME,SAAAA,GAAYC,OAAQ,CAAA,gBAAA,CAAA,CAAkBC,SAAS;YAErD,MAAMC,YAAAA,GAAeN,OAAI,oBAAsBH,CAAAA,CAAAA,GAAAA,CAAAA;AAC/C,YAAA,MAAMU,SAAYC,GAAAA,WAAAA,CAASF,YAAgBA,CAAAA,GAAAA,YAAAA,CAAaG,WAAW,EAAK,GAAA,cAAA;AAExE,YAAA,MAAMC,cAAcF,WAASX,CAAAA,GAAAA,CAAIc,OAAO,CAACC,IAAI,IACzCC,UAAQD,CAAAA,IAAAA,CAAKE,SAAS,CAACjB,GAAAA,CAAIc,OAAO,CAACC,IAAI,GAAGG,OAAO,CAAC,OAAO,EACzD,CAAA,GAAA,aAAA;AAEJ,YAAA,MAAMC,UAAa,GAAA;gBACjBC,QAAU,EAAA;oBAAEC,GAAK,EAAA;AAAE,iBAAA;gBACnBC,GAAK,EAAA,CAAA;AACLC,gBAAAA,SAAAA,EAAW,CAAC,EAAEb,SAAU,CAAA,CAAC,EAAEG,WAAAA,CAAY,CAAC,EAAEb,GAAIc,CAAAA,OAAO,CAACU,EAAE,CAAC,CAAC;AAC1DC,gBAAAA,OAAAA,CAAAA,GAAAA;AACE,oBAAA,MAAM,IAAI9B,cAAAA,EAAAA;AACZ,iBAAA;AACA,gBAAA,GAAGO,eAAe;AAClB,gBAAA,GAAGJ;AACL,aAAA;AAEA,YAAA,OAAOQ,SAAUoB,CAAAA,UAAU,CAACP,UAAAA,CAAAA,CAAYnB,GAAKC,EAAAA,IAAAA,CAAAA;AAC/C;QAEA,OAAOA,IAAAA,EAAAA;AACT,KAAA;;;;"}