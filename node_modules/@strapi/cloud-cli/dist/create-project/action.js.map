{"version":3,"file":"action.js","sources":["../../src/create-project/action.ts"],"sourcesContent":["import inquirer from 'inquirer';\nimport { AxiosError } from 'axios';\nimport { defaults } from 'lodash/fp';\nimport type { CLIContext, ProjectAnswers, ProjectInput } from '../types';\nimport { cloudApiFactory, local, tokenServiceFactory } from '../services';\nimport { getProjectNameFromPackageJson } from './utils/get-project-name-from-pkg';\nimport { promptLogin } from '../login/action';\nimport {\n  getDefaultsFromQuestions,\n  getProjectNodeVersionDefault,\n  questionDefaultValuesMapper,\n} from './utils/project-questions.utils';\n\nasync function handleError(ctx: CLIContext, error: Error) {\n  const { logger } = ctx;\n  logger.debug(error);\n  if (error instanceof AxiosError) {\n    const errorMessage = typeof error.response?.data === 'string' ? error.response.data : null;\n    switch (error.response?.status) {\n      case 403:\n        logger.error(\n          errorMessage ||\n            'You do not have permission to create a project. Please contact support for assistance.'\n        );\n        return;\n      case 400:\n        logger.error(errorMessage || 'Invalid input. Please check your inputs and try again.');\n        return;\n      case 503:\n        logger.error(\n          'Strapi Cloud project creation is currently unavailable. Please try again later.'\n        );\n        return;\n      default:\n        if (errorMessage) {\n          logger.error(errorMessage);\n          return;\n        }\n        break;\n    }\n  }\n  logger.error(\n    'We encountered an issue while creating your project. Please try again in a moment. If the problem persists, contact support for assistance.'\n  );\n}\n\nasync function createProject(ctx: CLIContext, cloudApi: any, projectInput: ProjectInput) {\n  const { logger } = ctx;\n  const spinner = logger.spinner('Setting up your project...').start();\n  try {\n    const { data } = await cloudApi.createProject(projectInput);\n    await local.save({ project: data });\n    spinner.succeed('Project created successfully!');\n    return data;\n  } catch (e: Error | unknown) {\n    spinner.fail('An error occurred while creating the project on Strapi Cloud.');\n    throw e;\n  }\n}\n\nexport default async (ctx: CLIContext) => {\n  const { logger } = ctx;\n  const { getValidToken, eraseToken } = await tokenServiceFactory(ctx);\n\n  const token = await getValidToken(ctx, promptLogin);\n  if (!token) {\n    return;\n  }\n\n  const cloudApi = await cloudApiFactory(ctx, token);\n  const { data: config } = await cloudApi.config();\n  const projectName = await getProjectNameFromPackageJson(ctx);\n\n  const defaultAnswersMapper = questionDefaultValuesMapper({\n    name: projectName,\n    nodeVersion: getProjectNodeVersionDefault,\n  });\n  const questions = defaultAnswersMapper(config.projectCreation.questions);\n  const defaultValues = {\n    ...config.projectCreation.defaults,\n    ...getDefaultsFromQuestions(questions),\n  };\n\n  const projectAnswersDefaulted = defaults(defaultValues);\n  const projectAnswers = await inquirer.prompt<ProjectAnswers>(questions);\n\n  const projectInput: ProjectInput = projectAnswersDefaulted(projectAnswers);\n\n  try {\n    return await createProject(ctx, cloudApi, projectInput);\n  } catch (e: Error | unknown) {\n    if (e instanceof AxiosError && e.response?.status === 401) {\n      logger.warn('Oops! Your session has expired. Please log in again to retry.');\n      await eraseToken();\n      if (await promptLogin(ctx)) {\n        return await createProject(ctx, cloudApi, projectInput);\n      }\n    } else {\n      await handleError(ctx, e as Error);\n    }\n  }\n};\n"],"names":["handleError","ctx","error","logger","debug","AxiosError","errorMessage","response","data","status","createProject","cloudApi","projectInput","spinner","start","local","project","succeed","e","fail","getValidToken","eraseToken","tokenServiceFactory","token","promptLogin","cloudApiFactory","config","projectName","getProjectNameFromPackageJson","defaultAnswersMapper","questionDefaultValuesMapper","name","nodeVersion","getProjectNodeVersionDefault","questions","projectCreation","defaultValues","defaults","getDefaultsFromQuestions","projectAnswersDefaulted","projectAnswers","inquirer","prompt","warn"],"mappings":"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"}