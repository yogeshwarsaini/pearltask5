{"version":3,"file":"component-builder.mjs","sources":["../../../../server/src/services/schema-builder/component-builder.ts"],"sourcesContent":["import path from 'path';\nimport type { Internal } from '@strapi/types';\nimport _ from 'lodash';\nimport pluralize from 'pluralize';\n\nimport { strings, errors } from '@strapi/utils';\nimport { isConfigurable } from '../../utils/attributes';\nimport createSchemaHandler from './schema-handler';\n\nconst { ApplicationError } = errors;\n\nexport default function createComponentBuilder() {\n  return {\n    createComponentUID({ category, displayName }: any) {\n      return `${strings.nameToSlug(category)}.${strings.nameToSlug(displayName)}`;\n    },\n\n    createNewComponentUIDMap(components: object[]) {\n      return components.reduce((uidMap: any, component: any) => {\n        uidMap[component.tmpUID] = this.createComponentUID(component);\n        return uidMap;\n      }, {});\n    },\n\n    createComponentAttributes(this: any, uid: string, attributes: any) {\n      if (!this.components.has(uid)) {\n        throw new ApplicationError('component.notFound');\n      }\n\n      return this.components.get(uid).setAttributes(this.convertAttributes(attributes));\n    },\n\n    /**\n     * create a component in the tmpComponent map\n     */\n    createComponent(this: any, infos: any) {\n      if (infos.uid && infos.uid !== this.createComponentUID(infos)) {\n        throw new ApplicationError('component.invalidUID');\n      }\n\n      const uid = infos.uid ?? this.createComponentUID(infos);\n\n      if (this.components.has(uid)) {\n        throw new ApplicationError('component.alreadyExists');\n      }\n\n      const handler = createSchemaHandler({\n        dir: path.join(strapi.dirs.app.components, strings.nameToSlug(infos.category)),\n        filename: `${strings.nameToSlug(infos.displayName)}.json`,\n      });\n\n      // TODO: create a utility for this\n      // Duplicate in admin/src/components/FormModal/forms/utils/createCollectionName.ts\n      const collectionName = `components_${strings.nameToCollectionName(\n        infos.category\n      )}_${strings.nameToCollectionName(pluralize(infos.displayName))}`;\n\n      this.components.forEach((compo: any) => {\n        if (compo.schema.collectionName === collectionName) {\n          throw new ApplicationError('component.alreadyExists');\n        }\n      });\n\n      handler\n        .setUID(uid)\n        .set('collectionName', collectionName)\n        .set(['info', 'displayName'], infos.displayName)\n        .set(['info', 'icon'], infos.icon)\n        .set(['info', 'description'], infos.description)\n        .set('pluginOptions', infos.pluginOptions)\n        .set('config', infos.config);\n\n      if (this.components.size === 0) {\n        strapi.telemetry.send('didCreateFirstComponent');\n      } else {\n        strapi.telemetry.send('didCreateComponent');\n      }\n\n      this.components.set(uid, handler);\n\n      this.createComponentAttributes(uid, infos.attributes);\n\n      return handler;\n    },\n\n    /**\n     * create a component in the tmpComponent map\n     */\n    editComponent(this: any, infos: any) {\n      const { uid } = infos;\n\n      if (!this.components.has(uid)) {\n        throw new errors.ApplicationError('component.notFound');\n      }\n\n      const component = this.components.get(uid);\n\n      const [, nameUID] = uid.split('.');\n\n      const newCategory = strings.nameToSlug(infos.category);\n      const newUID = `${newCategory}.${nameUID}`;\n\n      if (newUID !== uid && this.components.has(newUID)) {\n        throw new errors.ApplicationError('component.edit.alreadyExists');\n      }\n\n      const newDir = path.join(strapi.dirs.app.components, newCategory);\n\n      const oldAttributes = component.schema.attributes;\n\n      const newAttributes = _.omitBy(infos.attributes, (attr, key) => {\n        return _.has(oldAttributes, key) && !isConfigurable(oldAttributes[key]);\n      });\n\n      component\n        .setUID(newUID)\n        .setDir(newDir)\n        .set(['info', 'displayName'], infos.displayName)\n        .set(['info', 'icon'], infos.icon)\n        .set(['info', 'description'], infos.description)\n        .set('pluginOptions', infos.pluginOptions)\n        .setAttributes(this.convertAttributes(newAttributes));\n\n      if (newUID !== uid) {\n        this.components.forEach((compo: any) => {\n          compo.updateComponent(uid, newUID);\n        });\n\n        this.contentTypes.forEach((ct: any) => {\n          ct.updateComponent(uid, newUID);\n        });\n      }\n\n      return component;\n    },\n\n    deleteComponent(this: any, uid: Internal.UID.Component) {\n      if (!this.components.has(uid)) {\n        throw new errors.ApplicationError('component.notFound');\n      }\n\n      this.components.forEach((compo: any) => {\n        compo.removeComponent(uid);\n      });\n\n      this.contentTypes.forEach((ct: any) => {\n        ct.removeComponent(uid);\n      });\n\n      return this.components.get(uid).delete();\n    },\n  };\n}\n"],"names":["ApplicationError","errors","createComponentBuilder","createComponentUID","category","displayName","strings","nameToSlug","createNewComponentUIDMap","components","reduce","uidMap","component","tmpUID","createComponentAttributes","uid","attributes","has","get","setAttributes","convertAttributes","createComponent","infos","handler","createSchemaHandler","dir","path","join","strapi","dirs","app","filename","collectionName","nameToCollectionName","pluralize","forEach","compo","schema","setUID","set","icon","description","pluginOptions","config","size","telemetry","send","editComponent","nameUID","split","newCategory","newUID","newDir","oldAttributes","newAttributes","_","omitBy","attr","key","isConfigurable","setDir","updateComponent","contentTypes","ct","deleteComponent","removeComponent","delete"],"mappings":";;;;;;;AASA,MAAM,EAAEA,gBAAgB,EAAE,GAAGC,MAAAA;AAEd,SAASC,sBAAAA,GAAAA;IACtB,OAAO;AACLC,QAAAA,kBAAAA,CAAAA,CAAmB,EAAEC,QAAQ,EAAEC,WAAW,EAAO,EAAA;AAC/C,YAAA,OAAO,CAAC,EAAEC,OAAQC,CAAAA,UAAU,CAACH,QAAAA,CAAAA,CAAU,CAAC,EAAEE,OAAQC,CAAAA,UAAU,CAACF,WAAAA,CAAAA,CAAa,CAAC;AAC7E,SAAA;AAEAG,QAAAA,wBAAAA,CAAAA,CAAyBC,UAAoB,EAAA;AAC3C,YAAA,OAAOA,UAAWC,CAAAA,MAAM,CAAC,CAACC,MAAaC,EAAAA,SAAAA,GAAAA;gBACrCD,MAAM,CAACC,UAAUC,MAAM,CAAC,GAAG,IAAI,CAACV,kBAAkB,CAACS,SAAAA,CAAAA;gBACnD,OAAOD,MAAAA;AACT,aAAA,EAAG,EAAC,CAAA;AACN,SAAA;QAEAG,yBAAqCC,CAAAA,CAAAA,GAAW,EAAEC,UAAe,EAAA;AAC/D,YAAA,IAAI,CAAC,IAAI,CAACP,UAAU,CAACQ,GAAG,CAACF,GAAM,CAAA,EAAA;AAC7B,gBAAA,MAAM,IAAIf,gBAAiB,CAAA,oBAAA,CAAA;AAC7B;AAEA,YAAA,OAAO,IAAI,CAACS,UAAU,CAACS,GAAG,CAACH,GAAKI,CAAAA,CAAAA,aAAa,CAAC,IAAI,CAACC,iBAAiB,CAACJ,UAAAA,CAAAA,CAAAA;AACvE,SAAA;AAEA;;AAEC,QACDK,iBAA2BC,KAAU,EAAA;YACnC,IAAIA,KAAAA,CAAMP,GAAG,IAAIO,KAAMP,CAAAA,GAAG,KAAK,IAAI,CAACZ,kBAAkB,CAACmB,KAAQ,CAAA,EAAA;AAC7D,gBAAA,MAAM,IAAItB,gBAAiB,CAAA,sBAAA,CAAA;AAC7B;AAEA,YAAA,MAAMe,MAAMO,KAAMP,CAAAA,GAAG,IAAI,IAAI,CAACZ,kBAAkB,CAACmB,KAAAA,CAAAA;AAEjD,YAAA,IAAI,IAAI,CAACb,UAAU,CAACQ,GAAG,CAACF,GAAM,CAAA,EAAA;AAC5B,gBAAA,MAAM,IAAIf,gBAAiB,CAAA,yBAAA,CAAA;AAC7B;AAEA,YAAA,MAAMuB,UAAUC,mBAAoB,CAAA;AAClCC,gBAAAA,GAAAA,EAAKC,aAAKC,CAAAA,IAAI,CAACC,MAAAA,CAAOC,IAAI,CAACC,GAAG,CAACrB,UAAU,EAAEH,OAAAA,CAAQC,UAAU,CAACe,MAAMlB,QAAQ,CAAA,CAAA;gBAC5E2B,QAAU,EAAA,CAAC,EAAEzB,OAAQC,CAAAA,UAAU,CAACe,KAAMjB,CAAAA,WAAW,CAAE,CAAA,KAAK;AAC1D,aAAA,CAAA;;;AAIA,YAAA,MAAM2B,iBAAiB,CAAC,WAAW,EAAE1B,OAAQ2B,CAAAA,oBAAoB,CAC/DX,KAAMlB,CAAAA,QAAQ,EACd,CAAC,EAAEE,QAAQ2B,oBAAoB,CAACC,UAAUZ,KAAMjB,CAAAA,WAAW,GAAG,CAAC;AAEjE,YAAA,IAAI,CAACI,UAAU,CAAC0B,OAAO,CAAC,CAACC,KAAAA,GAAAA;AACvB,gBAAA,IAAIA,KAAMC,CAAAA,MAAM,CAACL,cAAc,KAAKA,cAAgB,EAAA;AAClD,oBAAA,MAAM,IAAIhC,gBAAiB,CAAA,yBAAA,CAAA;AAC7B;AACF,aAAA,CAAA;YAEAuB,OACGe,CAAAA,MAAM,CAACvB,GACPwB,CAAAA,CAAAA,GAAG,CAAC,gBAAkBP,EAAAA,cAAAA,CAAAA,CACtBO,GAAG,CAAC;AAAC,gBAAA,MAAA;AAAQ,gBAAA;AAAc,aAAA,EAAEjB,KAAMjB,CAAAA,WAAW,CAC9CkC,CAAAA,GAAG,CAAC;AAAC,gBAAA,MAAA;AAAQ,gBAAA;AAAO,aAAA,EAAEjB,KAAMkB,CAAAA,IAAI,CAChCD,CAAAA,GAAG,CAAC;AAAC,gBAAA,MAAA;AAAQ,gBAAA;AAAc,aAAA,EAAEjB,KAAMmB,CAAAA,WAAW,CAC9CF,CAAAA,GAAG,CAAC,eAAA,EAAiBjB,KAAMoB,CAAAA,aAAa,CACxCH,CAAAA,GAAG,CAAC,QAAA,EAAUjB,MAAMqB,MAAM,CAAA;AAE7B,YAAA,IAAI,IAAI,CAAClC,UAAU,CAACmC,IAAI,KAAK,CAAG,EAAA;gBAC9BhB,MAAOiB,CAAAA,SAAS,CAACC,IAAI,CAAC,yBAAA,CAAA;aACjB,MAAA;gBACLlB,MAAOiB,CAAAA,SAAS,CAACC,IAAI,CAAC,oBAAA,CAAA;AACxB;AAEA,YAAA,IAAI,CAACrC,UAAU,CAAC8B,GAAG,CAACxB,GAAKQ,EAAAA,OAAAA,CAAAA;AAEzB,YAAA,IAAI,CAACT,yBAAyB,CAACC,GAAAA,EAAKO,MAAMN,UAAU,CAAA;YAEpD,OAAOO,OAAAA;AACT,SAAA;AAEA;;AAEC,QACDwB,eAAyBzB,KAAU,EAAA;YACjC,MAAM,EAAEP,GAAG,EAAE,GAAGO,KAAAA;AAEhB,YAAA,IAAI,CAAC,IAAI,CAACb,UAAU,CAACQ,GAAG,CAACF,GAAM,CAAA,EAAA;gBAC7B,MAAM,IAAId,MAAOD,CAAAA,gBAAgB,CAAC,oBAAA,CAAA;AACpC;AAEA,YAAA,MAAMY,YAAY,IAAI,CAACH,UAAU,CAACS,GAAG,CAACH,GAAAA,CAAAA;AAEtC,YAAA,MAAM,GAAGiC,OAAAA,CAAQ,GAAGjC,GAAAA,CAAIkC,KAAK,CAAC,GAAA,CAAA;AAE9B,YAAA,MAAMC,WAAc5C,GAAAA,OAAAA,CAAQC,UAAU,CAACe,MAAMlB,QAAQ,CAAA;AACrD,YAAA,MAAM+C,SAAS,CAAC,EAAED,YAAY,CAAC,EAAEF,QAAQ,CAAC;YAE1C,IAAIG,MAAAA,KAAWpC,OAAO,IAAI,CAACN,UAAU,CAACQ,GAAG,CAACkC,MAAS,CAAA,EAAA;gBACjD,MAAM,IAAIlD,MAAOD,CAAAA,gBAAgB,CAAC,8BAAA,CAAA;AACpC;YAEA,MAAMoD,MAAAA,GAAS1B,aAAKC,CAAAA,IAAI,CAACC,MAAAA,CAAOC,IAAI,CAACC,GAAG,CAACrB,UAAU,EAAEyC,WAAAA,CAAAA;AAErD,YAAA,MAAMG,aAAgBzC,GAAAA,SAAAA,CAAUyB,MAAM,CAACrB,UAAU;YAEjD,MAAMsC,aAAAA,GAAgBC,EAAEC,MAAM,CAAClC,MAAMN,UAAU,EAAE,CAACyC,IAAMC,EAAAA,GAAAA,GAAAA;gBACtD,OAAOH,CAAAA,CAAEtC,GAAG,CAACoC,aAAAA,EAAeK,QAAQ,CAACC,cAAAA,CAAeN,aAAa,CAACK,GAAI,CAAA,CAAA;AACxE,aAAA,CAAA;AAEA9C,YAAAA,SAAAA,CACG0B,MAAM,CAACa,MAAAA,CAAAA,CACPS,MAAM,CAACR,MAAAA,CAAAA,CACPb,GAAG,CAAC;AAAC,gBAAA,MAAA;AAAQ,gBAAA;AAAc,aAAA,EAAEjB,KAAMjB,CAAAA,WAAW,CAC9CkC,CAAAA,GAAG,CAAC;AAAC,gBAAA,MAAA;AAAQ,gBAAA;AAAO,aAAA,EAAEjB,KAAMkB,CAAAA,IAAI,CAChCD,CAAAA,GAAG,CAAC;AAAC,gBAAA,MAAA;AAAQ,gBAAA;AAAc,aAAA,EAAEjB,KAAMmB,CAAAA,WAAW,CAC9CF,CAAAA,GAAG,CAAC,eAAiBjB,EAAAA,KAAAA,CAAMoB,aAAa,CAAA,CACxCvB,aAAa,CAAC,IAAI,CAACC,iBAAiB,CAACkC,aAAAA,CAAAA,CAAAA;AAExC,YAAA,IAAIH,WAAWpC,GAAK,EAAA;AAClB,gBAAA,IAAI,CAACN,UAAU,CAAC0B,OAAO,CAAC,CAACC,KAAAA,GAAAA;oBACvBA,KAAMyB,CAAAA,eAAe,CAAC9C,GAAKoC,EAAAA,MAAAA,CAAAA;AAC7B,iBAAA,CAAA;AAEA,gBAAA,IAAI,CAACW,YAAY,CAAC3B,OAAO,CAAC,CAAC4B,EAAAA,GAAAA;oBACzBA,EAAGF,CAAAA,eAAe,CAAC9C,GAAKoC,EAAAA,MAAAA,CAAAA;AAC1B,iBAAA,CAAA;AACF;YAEA,OAAOvC,SAAAA;AACT,SAAA;AAEAoD,QAAAA,eAAAA,CAAAA,CAA2BjD,GAA2B,EAAA;AACpD,YAAA,IAAI,CAAC,IAAI,CAACN,UAAU,CAACQ,GAAG,CAACF,GAAM,CAAA,EAAA;gBAC7B,MAAM,IAAId,MAAOD,CAAAA,gBAAgB,CAAC,oBAAA,CAAA;AACpC;AAEA,YAAA,IAAI,CAACS,UAAU,CAAC0B,OAAO,CAAC,CAACC,KAAAA,GAAAA;AACvBA,gBAAAA,KAAAA,CAAM6B,eAAe,CAAClD,GAAAA,CAAAA;AACxB,aAAA,CAAA;AAEA,YAAA,IAAI,CAAC+C,YAAY,CAAC3B,OAAO,CAAC,CAAC4B,EAAAA,GAAAA;AACzBA,gBAAAA,EAAAA,CAAGE,eAAe,CAAClD,GAAAA,CAAAA;AACrB,aAAA,CAAA;AAEA,YAAA,OAAO,IAAI,CAACN,UAAU,CAACS,GAAG,CAACH,KAAKmD,MAAM,EAAA;AACxC;AACF,KAAA;AACF;;;;"}