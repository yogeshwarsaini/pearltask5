{"version":3,"file":"fetch.mjs","sources":["../../src/utils/fetch.ts"],"sourcesContent":["import type { Core, Modules } from '@strapi/types';\nimport { ProxyAgent } from 'undici';\n\n// TODO: once core Node exposes a stable way to create a ProxyAgent we will use that instead of undici\n\ninterface StrapiFetchOptions {\n  logs?: boolean;\n}\n\n// Create a wrapper for Node's Fetch API that applies a global proxy\nexport const createStrapiFetch = (\n  strapi: Core.Strapi,\n  options?: StrapiFetchOptions\n): Modules.Fetch.Fetch => {\n  const { logs = true } = options ?? {};\n\n  function strapiFetch(url: RequestInfo | URL, options?: RequestInit) {\n    const fetchOptions = {\n      ...(strapiFetch.dispatcher ? { dispatcher: strapiFetch.dispatcher } : {}),\n      ...options,\n    };\n\n    if (logs) {\n      strapi.log.debug(`Making request for ${url}`);\n    }\n\n    return fetch(url, fetchOptions);\n  }\n\n  const proxy =\n    strapi.config.get<ConstructorParameters<typeof ProxyAgent>[0]>('server.proxy.fetch') ||\n    strapi.config.get<string>('server.proxy.global');\n\n  if (proxy) {\n    if (logs) {\n      strapi.log.info(`Using proxy for Fetch requests: ${proxy}`);\n    }\n    strapiFetch.dispatcher = new ProxyAgent(proxy);\n  }\n\n  return strapiFetch;\n};\n\nexport type Fetch = Modules.Fetch.Fetch;\n"],"names":["createStrapiFetch","strapi","options","logs","strapiFetch","url","fetchOptions","dispatcher","log","debug","fetch","proxy","config","get","info","ProxyAgent"],"mappings":";;AASA;AACO,MAAMA,iBAAoB,GAAA,CAC/BC,MACAC,EAAAA,OAAAA,GAAAA;AAEA,IAAA,MAAM,EAAEC,IAAO,GAAA,IAAI,EAAE,GAAGD,WAAW,EAAC;IAEpC,SAASE,WAAAA,CAAYC,GAAsB,EAAEH,OAAqB,EAAA;AAChE,QAAA,MAAMI,YAAe,GAAA;YACnB,GAAIF,WAAAA,CAAYG,UAAU,GAAG;AAAEA,gBAAAA,UAAAA,EAAYH,YAAYG;AAAW,aAAA,GAAI,EAAE;AACxE,YAAA,GAAGL;AACL,SAAA;AAEA,QAAA,IAAIC,IAAM,EAAA;YACRF,MAAOO,CAAAA,GAAG,CAACC,KAAK,CAAC,CAAC,mBAAmB,EAAEJ,IAAI,CAAC,CAAA;AAC9C;AAEA,QAAA,OAAOK,MAAML,GAAKC,EAAAA,YAAAA,CAAAA;AACpB;IAEA,MAAMK,KAAAA,GACJV,MAAOW,CAAAA,MAAM,CAACC,GAAG,CAA8C,oBAAA,CAAA,IAC/DZ,MAAOW,CAAAA,MAAM,CAACC,GAAG,CAAS,qBAAA,CAAA;AAE5B,IAAA,IAAIF,KAAO,EAAA;AACT,QAAA,IAAIR,IAAM,EAAA;YACRF,MAAOO,CAAAA,GAAG,CAACM,IAAI,CAAC,CAAC,gCAAgC,EAAEH,MAAM,CAAC,CAAA;AAC5D;QACAP,WAAYG,CAAAA,UAAU,GAAG,IAAIQ,UAAWJ,CAAAA,KAAAA,CAAAA;AAC1C;IAEA,OAAOP,WAAAA;AACT;;;;"}