{"version":3,"file":"middleware.mjs","sources":["../../../src/services/metrics/middleware.ts"],"sourcesContent":["import type { Core } from '@strapi/types';\nimport type { Sender } from './sender';\n\ninterface State {\n  expires: number;\n  counter: number;\n}\n\nfunction nextResetDate(): number {\n  return Date.now() + 24 * 60 * 60 * 1000; // Now + 24 hours.\n}\n\nconst createMiddleware = ({ sendEvent }: { sendEvent: Sender }) => {\n  const state: State = {\n    expires: nextResetDate(),\n    counter: 0,\n  };\n\n  const middleware: Core.MiddlewareHandler = async (ctx, next) => {\n    const { url, method } = ctx.request;\n\n    if (!url.includes('.') && ['GET', 'PUT', 'POST', 'DELETE'].includes(method)) {\n      if (Date.now() > state.expires) {\n        state.expires = nextResetDate();\n        state.counter = 0;\n      }\n\n      // Send max. 1000 events per day.\n      if (state.counter < 1000) {\n        sendEvent('didReceiveRequest', { eventProperties: { url: ctx.request.url } });\n\n        // Increase counter.\n        state.counter += 1;\n      }\n    }\n\n    await next();\n  };\n\n  return middleware;\n};\n\nexport default createMiddleware;\n"],"names":["nextResetDate","Date","now","createMiddleware","sendEvent","state","expires","counter","middleware","ctx","next","url","method","request","includes","eventProperties"],"mappings":"AAQA,SAASA,aAAAA,GAAAA;AACP,IAAA,OAAOC,KAAKC,GAAG,EAAA,GAAK,KAAK,EAAK,GAAA,EAAA,GAAK;AACrC;AAEA,MAAMC,gBAAmB,GAAA,CAAC,EAAEC,SAAS,EAAyB,GAAA;AAC5D,IAAA,MAAMC,KAAe,GAAA;QACnBC,OAASN,EAAAA,aAAAA,EAAAA;QACTO,OAAS,EAAA;AACX,KAAA;IAEA,MAAMC,UAAAA,GAAqC,OAAOC,GAAKC,EAAAA,IAAAA,GAAAA;AACrD,QAAA,MAAM,EAAEC,GAAG,EAAEC,MAAM,EAAE,GAAGH,IAAII,OAAO;AAEnC,QAAA,IAAI,CAACF,GAAAA,CAAIG,QAAQ,CAAC,GAAQ,CAAA,IAAA;AAAC,YAAA,KAAA;AAAO,YAAA,KAAA;AAAO,YAAA,MAAA;AAAQ,YAAA;SAAS,CAACA,QAAQ,CAACF,MAAS,CAAA,EAAA;AAC3E,YAAA,IAAIX,IAAKC,CAAAA,GAAG,EAAKG,GAAAA,KAAAA,CAAMC,OAAO,EAAE;AAC9BD,gBAAAA,KAAAA,CAAMC,OAAO,GAAGN,aAAAA,EAAAA;AAChBK,gBAAAA,KAAAA,CAAME,OAAO,GAAG,CAAA;AAClB;;YAGA,IAAIF,KAAAA,CAAME,OAAO,GAAG,IAAM,EAAA;AACxBH,gBAAAA,SAAAA,CAAU,mBAAqB,EAAA;oBAAEW,eAAiB,EAAA;wBAAEJ,GAAKF,EAAAA,GAAAA,CAAII,OAAO,CAACF;AAAI;AAAE,iBAAA,CAAA;;AAG3EN,gBAAAA,KAAAA,CAAME,OAAO,IAAI,CAAA;AACnB;AACF;QAEA,MAAMG,IAAAA,EAAAA;AACR,KAAA;IAEA,OAAOF,UAAAA;AACT;;;;"}