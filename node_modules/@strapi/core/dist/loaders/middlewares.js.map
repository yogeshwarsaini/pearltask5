{"version":3,"file":"middlewares.js","sources":["../../src/loaders/middlewares.ts"],"sourcesContent":["import { join, extname, basename } from 'path';\nimport fse from 'fs-extra';\nimport { importDefault } from '@strapi/utils';\nimport type { Core } from '@strapi/types';\nimport { middlewares as internalMiddlewares } from '../middlewares';\n\n// TODO:: allow folders with index.js inside for bigger policies\nexport default async function loadMiddlewares(strapi: Core.Strapi) {\n  const localMiddlewares = await loadLocalMiddlewares(strapi);\n\n  strapi.get('middlewares').add(`global::`, localMiddlewares);\n  strapi.get('middlewares').add(`strapi::`, internalMiddlewares);\n}\n\nconst loadLocalMiddlewares = async (strapi: Core.Strapi) => {\n  const dir = strapi.dirs.dist.middlewares;\n\n  if (!(await fse.pathExists(dir))) {\n    return {};\n  }\n\n  const middlewares: Record<string, Core.MiddlewareFactory> = {};\n  const paths = await fse.readdir(dir, { withFileTypes: true });\n\n  for (const fd of paths) {\n    const { name } = fd;\n    const fullPath = join(dir, name);\n\n    if (fd.isFile() && extname(name) === '.js') {\n      const key = basename(name, '.js');\n      middlewares[key] = importDefault(fullPath);\n    }\n  }\n\n  return middlewares;\n};\n"],"names":["loadMiddlewares","strapi","localMiddlewares","loadLocalMiddlewares","get","add","internalMiddlewares","dir","dirs","dist","middlewares","fse","pathExists","paths","readdir","withFileTypes","fd","name","fullPath","join","isFile","extname","key","basename","importDefault"],"mappings":";;;;;;;AAMA;AACe,eAAeA,gBAAgBC,MAAmB,EAAA;IAC/D,MAAMC,gBAAAA,GAAmB,MAAMC,oBAAqBF,CAAAA,MAAAA,CAAAA;IAEpDA,MAAOG,CAAAA,GAAG,CAAC,aAAeC,CAAAA,CAAAA,GAAG,CAAC,CAAC,QAAQ,CAAC,EAAEH,gBAAAA,CAAAA;IAC1CD,MAAOG,CAAAA,GAAG,CAAC,aAAeC,CAAAA,CAAAA,GAAG,CAAC,CAAC,QAAQ,CAAC,EAAEC,iBAAAA,CAAAA;AAC5C;AAEA,MAAMH,uBAAuB,OAAOF,MAAAA,GAAAA;AAClC,IAAA,MAAMM,MAAMN,MAAOO,CAAAA,IAAI,CAACC,IAAI,CAACC,WAAW;AAExC,IAAA,IAAI,CAAE,MAAMC,GAAIC,CAAAA,UAAU,CAACL,GAAO,CAAA,EAAA;AAChC,QAAA,OAAO,EAAC;AACV;AAEA,IAAA,MAAMG,cAAsD,EAAC;AAC7D,IAAA,MAAMG,KAAQ,GAAA,MAAMF,GAAIG,CAAAA,OAAO,CAACP,GAAK,EAAA;QAAEQ,aAAe,EAAA;AAAK,KAAA,CAAA;IAE3D,KAAK,MAAMC,MAAMH,KAAO,CAAA;QACtB,MAAM,EAAEI,IAAI,EAAE,GAAGD,EAAAA;QACjB,MAAME,QAAAA,GAAWC,UAAKZ,GAAKU,EAAAA,IAAAA,CAAAA;AAE3B,QAAA,IAAID,EAAGI,CAAAA,MAAM,EAAMC,IAAAA,YAAAA,CAAQJ,UAAU,KAAO,EAAA;YAC1C,MAAMK,GAAAA,GAAMC,cAASN,IAAM,EAAA,KAAA,CAAA;YAC3BP,WAAW,CAACY,GAAI,CAAA,GAAGE,yBAAcN,CAAAA,QAAAA,CAAAA;AACnC;AACF;IAEA,OAAOR,WAAAA;AACT,CAAA;;;;"}