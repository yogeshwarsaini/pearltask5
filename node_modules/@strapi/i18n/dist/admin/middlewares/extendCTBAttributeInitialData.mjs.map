{"version":3,"file":"extendCTBAttributeInitialData.mjs","sources":["../../../admin/src/middlewares/extendCTBAttributeInitialData.ts"],"sourcesContent":["import get from 'lodash/get';\n\nimport type { Middleware } from '@reduxjs/toolkit';\nimport type { Store } from '@strapi/admin/strapi-admin';\n\nconst extendCTBAttributeInitialDataMiddleware: () => Middleware<\n  object,\n  ReturnType<Store['getState']>\n> = () => {\n  return ({ getState }) =>\n    (next) =>\n    (action) => {\n      const enhanceAction = ({ uid }: { uid: string }) => {\n        // the block here is to catch the error when trying to access the state\n        // of the ctb when the plugin is not mounted\n        try {\n          const store = getState();\n\n          const type = get(store, [\n            'content-type-builder_dataManagerProvider',\n            'current',\n            'contentTypes',\n            uid,\n          ]);\n\n          if (!type || type.modelType !== 'contentType') {\n            return next(action);\n          }\n\n          const hasi18nEnabled = get(type, ['pluginOptions', 'i18n', 'localized'], false);\n\n          if (hasi18nEnabled) {\n            return next({\n              ...action,\n              payload: {\n                ...action.payload,\n                options: {\n                  pluginOptions: {\n                    ...(action?.payload?.options?.pluginOptions ?? {}),\n                    i18n: {\n                      localized: true,\n                    },\n                  },\n                },\n              },\n            });\n          }\n\n          return next(action);\n        } catch (err) {\n          return next(action);\n        }\n      };\n\n      const { payload = {}, type } = action ?? {};\n\n      if (\n        type === 'formModal/setAttributeDataSchema' &&\n        !['relation', 'component'].includes(payload.attributeType) &&\n        !payload.isEditing\n      ) {\n        return enhanceAction({\n          uid: payload.uid,\n        });\n      }\n\n      if (type === 'formModal/setCustomFieldDataSchema' && !payload.isEditing) {\n        return enhanceAction({\n          uid: payload.uid,\n        });\n      }\n\n      if (\n        type === 'formModal/resetPropsAndSetFormForAddingAnExistingCompo' ||\n        type === 'formModal/resetPropsAndSaveCurrentData'\n      ) {\n        return enhanceAction({\n          uid: payload.uid,\n        });\n      }\n\n      return next(action);\n    };\n};\n\nexport { extendCTBAttributeInitialDataMiddleware };\n"],"names":["extendCTBAttributeInitialDataMiddleware","getState","next","action","enhanceAction","uid","store","type","get","modelType","hasi18nEnabled","payload","options","pluginOptions","i18n","localized","err","includes","attributeType","isEditing"],"mappings":";;AAKA,MAAMA,uCAGF,GAAA,IAAA;AACF,IAAA,OAAO,CAAC,EAAEC,QAAQ,EAAE,GAClB,CAACC,OACD,CAACC,MAAAA,GAAAA;AACC,gBAAA,MAAMC,aAAgB,GAAA,CAAC,EAAEC,GAAG,EAAmB,GAAA;;;oBAG7C,IAAI;AACF,wBAAA,MAAMC,KAAQL,GAAAA,QAAAA,EAAAA;wBAEd,MAAMM,IAAAA,GAAOC,IAAIF,KAAO,EAAA;AACtB,4BAAA,0CAAA;AACA,4BAAA,SAAA;AACA,4BAAA,cAAA;AACAD,4BAAAA;AACD,yBAAA,CAAA;AAED,wBAAA,IAAI,CAACE,IAAAA,IAAQA,IAAKE,CAAAA,SAAS,KAAK,aAAe,EAAA;AAC7C,4BAAA,OAAOP,IAAKC,CAAAA,MAAAA,CAAAA;AACd;wBAEA,MAAMO,cAAAA,GAAiBF,IAAID,IAAM,EAAA;AAAC,4BAAA,eAAA;AAAiB,4BAAA,MAAA;AAAQ,4BAAA;yBAAY,EAAE,KAAA,CAAA;AAEzE,wBAAA,IAAIG,cAAgB,EAAA;AAClB,4BAAA,OAAOR,IAAK,CAAA;AACV,gCAAA,GAAGC,MAAM;gCACTQ,OAAS,EAAA;AACP,oCAAA,GAAGR,OAAOQ,OAAO;oCACjBC,OAAS,EAAA;wCACPC,aAAe,EAAA;AACb,4CAAA,GAAIV,MAAQQ,EAAAA,OAAAA,EAASC,OAASC,EAAAA,aAAAA,IAAiB,EAAE;4CACjDC,IAAM,EAAA;gDACJC,SAAW,EAAA;AACb;AACF;AACF;AACF;AACF,6BAAA,CAAA;AACF;AAEA,wBAAA,OAAOb,IAAKC,CAAAA,MAAAA,CAAAA;AACd,qBAAA,CAAE,OAAOa,GAAK,EAAA;AACZ,wBAAA,OAAOd,IAAKC,CAAAA,MAAAA,CAAAA;AACd;AACF,iBAAA;gBAEA,MAAM,EAAEQ,UAAU,EAAE,EAAEJ,IAAI,EAAE,GAAGJ,MAAAA,IAAU,EAAC;gBAE1C,IACEI,IAAAA,KAAS,sCACT,CAAC;AAAC,oBAAA,UAAA;AAAY,oBAAA;iBAAY,CAACU,QAAQ,CAACN,OAAQO,CAAAA,aAAa,KACzD,CAACP,OAAAA,CAAQQ,SAAS,EAClB;AACA,oBAAA,OAAOf,aAAc,CAAA;AACnBC,wBAAAA,GAAAA,EAAKM,QAAQN;AACf,qBAAA,CAAA;AACF;AAEA,gBAAA,IAAIE,IAAS,KAAA,oCAAA,IAAwC,CAACI,OAAAA,CAAQQ,SAAS,EAAE;AACvE,oBAAA,OAAOf,aAAc,CAAA;AACnBC,wBAAAA,GAAAA,EAAKM,QAAQN;AACf,qBAAA,CAAA;AACF;gBAEA,IACEE,IAAAA,KAAS,wDACTA,IAAAA,IAAAA,KAAS,wCACT,EAAA;AACA,oBAAA,OAAOH,aAAc,CAAA;AACnBC,wBAAAA,GAAAA,EAAKM,QAAQN;AACf,qBAAA,CAAA;AACF;AAEA,gBAAA,OAAOH,IAAKC,CAAAA,MAAAA,CAAAA;AACd,aAAA;AACJ;;;;"}