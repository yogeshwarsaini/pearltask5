{"version":3,"file":"disable.js","sources":["../../../../../src/cli/commands/telemetry/disable.ts"],"sourcesContent":["import { resolve } from 'path';\nimport fse from 'fs-extra';\nimport chalk from 'chalk';\nimport { createCommand } from 'commander';\n\nimport type { StrapiCommand } from '../../types';\nimport { runAction } from '../../utils/helpers';\nimport { sendEvent } from '../../utils/telemetry';\n\nconst readPackageJSON = async (path: string) => {\n  try {\n    const packageObj = await fse.readJson(path);\n    const uuid = packageObj.strapi ? packageObj.strapi.uuid : null;\n    const installId = packageObj.strapi ? packageObj.strapi.installId : null;\n\n    return { uuid, installId, packageObj };\n  } catch (err) {\n    if (err instanceof Error) {\n      console.error(`${chalk.red('Error')}: ${err.message}`);\n    }\n  }\n};\n\nconst writePackageJSON = async (path: string, file: object, spacing: number) => {\n  try {\n    await fse.writeJson(path, file, { spaces: spacing });\n    return true;\n  } catch (err) {\n    if (err instanceof Error) {\n      console.error(`${chalk.red('Error')}: ${err.message}`);\n    }\n  }\n};\n\nconst action = async () => {\n  const packageJSONPath = resolve(process.cwd(), 'package.json');\n  const exists = await fse.pathExists(packageJSONPath);\n\n  if (!exists) {\n    console.log(`${chalk.yellow('Warning')}: could not find package.json`);\n    process.exit(0);\n  }\n\n  const { uuid, installId, packageObj } = (await readPackageJSON(packageJSONPath)) ?? {};\n\n  if ((packageObj.strapi && packageObj.strapi.telemetryDisabled) || !uuid) {\n    console.log(`${chalk.yellow('Warning:')} telemetry is already disabled`);\n    process.exit(0);\n  }\n\n  const updatedPackageJSON = {\n    ...packageObj,\n    strapi: {\n      ...packageObj.strapi,\n      telemetryDisabled: true,\n    },\n  };\n\n  const write = await writePackageJSON(packageJSONPath, updatedPackageJSON, 2);\n\n  if (!write) {\n    console.log(\n      `${chalk.yellow(\n        'Warning'\n      )}: There has been an error, please set \"telemetryDisabled\": true in the \"strapi\" object of your package.json manually.`\n    );\n    process.exit(0);\n  }\n\n  await sendEvent('didOptOutTelemetry', uuid, installId);\n  console.log(`${chalk.green('Successfully opted out of Strapi telemetry')}`);\n  process.exit(0);\n};\n\n/**\n * `$ strapi telemetry:disable`\n */\nconst command: StrapiCommand = () => {\n  return createCommand('telemetry:disable')\n    .description('Disable anonymous telemetry and metadata sending to Strapi analytics')\n    .action(runAction('telemetry:disable', action));\n};\n\nexport { action, command };\n"],"names":["readPackageJSON","path","packageObj","fse","readJson","uuid","strapi","installId","err","Error","console","error","chalk","red","message","writePackageJSON","file","spacing","writeJson","spaces","action","packageJSONPath","resolve","process","cwd","exists","pathExists","log","yellow","exit","telemetryDisabled","updatedPackageJSON","write","sendEvent","green","command","createCommand","description","runAction"],"mappings":"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"}